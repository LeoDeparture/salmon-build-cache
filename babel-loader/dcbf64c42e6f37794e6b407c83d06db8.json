{"ast":null,"code":"import \"antd/lib/button/style\";\nimport _Button from \"antd/lib/button\";\nimport \"antd/lib/checkbox/style\";\nimport _Checkbox from \"antd/lib/checkbox\";\nimport \"antd/lib/modal/style\";\nimport _Modal from \"antd/lib/modal\";\nimport \"antd/lib/icon/style\";\nimport _Icon from \"antd/lib/icon\";\nimport \"antd/lib/message/style\";\nimport _message from \"antd/lib/message\";\nimport _classCallCheck from \"@babel/runtime-corejs2/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime-corejs2/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"@babel/runtime-corejs2/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"@babel/runtime-corejs2/helpers/esm/getPrototypeOf\";\nimport _assertThisInitialized from \"@babel/runtime-corejs2/helpers/esm/assertThisInitialized\";\nimport _inherits from \"@babel/runtime-corejs2/helpers/esm/inherits\";\nimport _defineProperty from \"@babel/runtime-corejs2/helpers/esm/defineProperty\";\nimport \"antd/lib/upload/style\";\nimport _Upload from \"antd/lib/upload\";\nimport axios from 'axios';\nimport getConfig from 'next/config';\nimport React from 'react';\nimport styled from 'styled-components';\nimport ModalTitle from '../../../../components/ModalTitle';\nimport { PageGrid } from '../../../../components/PageLayout';\nimport { parseErrorCode } from '../../../../lib/commonJs';\nimport { Item, ItemContent, ItemTitle } from '../../components/CSSComponents';\nimport { PaperClip } from './ModuleInfo';\n\nvar _getConfig = getConfig(),\n    publicRuntimeConfig = _getConfig.publicRuntimeConfig;\n\nvar Dragger = _Upload.Dragger;\n\nvar AgreementContainer =\n/*#__PURE__*/\nfunction (_React$Component) {\n  _inherits(AgreementContainer, _React$Component);\n\n  function AgreementContainer(props) {\n    var _this;\n\n    _classCallCheck(this, AgreementContainer);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(AgreementContainer).call(this, props));\n\n    _defineProperty(_assertThisInitialized(_this), \"getFileList\", function (info) {\n      var status = info.file.status;\n\n      if (status === 'done') {\n        _this.setState({\n          FileList: info.fileList\n        });\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"customRequest\", function (_ref) {\n      var file = _ref.file,\n          onError = _ref.onError,\n          onProgress = _ref.onProgress,\n          onSuccess = _ref.onSuccess;\n      var fileParts = file.name.split('.');\n      var fileName = fileParts[0];\n      var fileType = file.type;\n      axios.post(\"\".concat(publicRuntimeConfig.serverUrl, \"/aws-s3-auth\"), {\n        fileName: fileName,\n        fileType: fileType\n      }, {\n        headers: {\n          'Content-Type': 'application/json',\n          'Access-Control-Allow-Origin': '*'\n        }\n      }).then(function (response) {\n        var returnData = response.data.data.returnData;\n        var signedRequest = returnData.signedRequest;\n        var url = returnData.url; // Put the fileType in the headers for the upload\n\n        var options = {\n          headers: {\n            'Content-Type': fileType,\n            'Access-Control-Allow-Origin': '*'\n          },\n          onUploadProgress: function onUploadProgress(_ref2) {\n            var loaded = _ref2.loaded,\n                total = _ref2.total;\n            onProgress({\n              percent: Math.round(loaded / total * 100)\n            }, file);\n\n            _this.setState({\n              buttonVisible: false\n            });\n          }\n        };\n        axios.put(signedRequest, file, options).then(function (result) {\n          if (result.status === 200) {\n            onSuccess(url, file);\n\n            _this.setState({\n              buttonVisible: false\n            });\n          }\n        }).catch(function () {\n          onError();\n        });\n      }).catch(function () {\n        onError();\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"onRemove\", function (removeItem) {\n      if (_this.state.FileList.length === 1) {\n        _this.setState({\n          buttonVisible: true\n        });\n      }\n\n      _this.setState({\n        FileList: _this.state.FileList.filter(function (item) {\n          return item.response !== removeItem.response;\n        })\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"handleOk\", function () {\n      _this.setState({\n        visible: false,\n        codeModal: true,\n        btnLoading: true\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"handleCancel\", function () {\n      _this.setState({\n        visible: false,\n        btnLoading: false\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"isNeedCode\", function (e) {\n      _this.setState({\n        needCode: e.target.checked\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"create\", function () {\n      var _this$props = _this.props,\n          id = _this$props.id,\n          updateAgreementInServiceTicket = _this$props.updateAgreementInServiceTicket;\n      var _this$state = _this.state,\n          FileList = _this$state.FileList,\n          needCode = _this$state.needCode;\n      var _FileList$ = FileList[0],\n          name = _FileList$.name,\n          response = _FileList$.response,\n          size = _FileList$.size;\n      updateAgreementInServiceTicket({\n        id: id,\n        agreement: {\n          url: response,\n          filename: name,\n          size: size\n        },\n        needCode: needCode\n      }).then(function (result) {\n        _this.setState({\n          codeModal: false,\n          confirmLoading: false\n        });\n      }).catch(function (error) {\n        if (parseErrorCode(error) === 'NoPhoneNumber') {\n          _message.error('此审核人还没有录入手机号，无法使用审核码功能');\n        }\n\n        setTimeout(function () {\n          _this.setState({\n            confirmLoading: false\n          });\n        }, 3000);\n      });\n\n      _this.setState({\n        confirmLoading: true,\n        btnLoading: false,\n        buttonVisible: true\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"hideModal\", function () {\n      _this.setState({\n        confirmLoading: false,\n        codeModal: false,\n        btnLoading: false,\n        buttonVisible: true\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"refreshServiceTicket\", function () {\n      var refetch = _this.props.refetch;\n      refetch().then(function (result) {\n        _this.setState({\n          status: result.data.getServiceTicketById.agreementFileStatus\n        });\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"retry\", function () {\n      var _this$props2 = _this.props,\n          generateServiceTicketContract = _this$props2.generateServiceTicketContract,\n          id = _this$props2.id,\n          refetch = _this$props2.refetch;\n      generateServiceTicketContract(id).then(function (result) {\n        if (result.data.generateServiceTicketContract.success) {\n          _this.setState({\n            status: 'CREATING'\n          });\n\n          setTimeout(function () {\n            refetch().then(function (success) {\n              var _success$data$getServ = success.data.getServiceTicketById,\n                  agreementFile = _success$data$getServ.agreementFile,\n                  agreementFileStatus = _success$data$getServ.agreementFileStatus;\n\n              if (agreementFile) {\n                _this.setState({\n                  status: agreementFileStatus\n                });\n              }\n            });\n          }, 5000);\n        }\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"changeFile\", function () {\n      _this.setState({\n        visible: true\n      });\n    });\n\n    _this.state = {\n      visible: false,\n      buttonVisible: true,\n      codeModal: false,\n      FileList: [],\n      fileSize: 0,\n      confirmLoading: false,\n      status: _this.props.agreementList.agreementFileStatus,\n      needCode: false,\n      btnLoading: false\n    };\n    return _this;\n  }\n\n  _createClass(AgreementContainer, [{\n    key: \"componentDidUpdate\",\n    value: function componentDidUpdate(prevProps) {\n      if (prevProps.agreementList.agreementFileStatus !== this.props.agreementList.agreementFileStatus) {\n        this.setState({\n          status: this.props.agreementList.agreementFileStatus\n        });\n      }\n    } // 获取FileList\n\n  }, {\n    key: \"render\",\n    value: function render() {\n      var agreementList = this.props.agreementList;\n      var payStatus = agreementList.payStatus,\n          agreementFile = agreementList.agreementFile;\n      var _this$state2 = this.state,\n          status = _this$state2.status,\n          visible = _this$state2.visible,\n          btnLoading = _this$state2.btnLoading,\n          buttonVisible = _this$state2.buttonVisible,\n          codeModal = _this$state2.codeModal,\n          confirmLoading = _this$state2.confirmLoading;\n      var content = null;\n\n      if (!status || status === 'CREATING') {\n        content = React.createElement(React.Fragment, null, React.createElement(ItemContent, null, \"\\u6B63\\u5728\\u751F\\u6210\\u534F\\u8BAE\\uFF0C\\u8BF7\\u7A0D\\u5019\\u3002\"), React.createElement(BtnWrapper, {\n          size: \"small\",\n          onClick: this.refreshServiceTicket\n        }, \"\\u5237\\u65B0\"));\n      } else if (status === 'FAILURE') {\n        content = React.createElement(React.Fragment, null, React.createElement(Text, null, \"\\u751F\\u6210\\u534F\\u8BAE\\u5931\\u8D25\\uFF0C\\u8BF7\\u91CD\\u8BD5\\u3002\"), React.createElement(BtnWrapper, {\n          size: \"small\",\n          onClick: this.retry\n        }, \"\\u91CD\\u8BD5\"));\n      } else if (status === 'COMPLETED' && agreementFile) {\n        content = React.createElement(PaperClip, {\n          url: agreementFile.file.url\n        }, agreementFile.file.filename);\n      } // 是否是线下签署协议\n\n\n      var isOffline = !!agreementFile && payStatus && payStatus.key === 'WAITING' && status === 'COMPLETED';\n      return React.createElement(React.Fragment, null, React.createElement(\"link\", {\n        rel: \"stylesheet\",\n        href: \"/static/css/custom.css\"\n      }), React.createElement(\"link\", {\n        rel: \"stylesheet\",\n        href: \"/static/css/upload.css\"\n      }), React.createElement(PageGrid, {\n        grid: [[{\n          content: React.createElement(AgreementWrapper, null, React.createElement(Item, null, React.createElement(ItemTitle, null, \"\\u534F\\u8BAE\\uFF1A\"), content || '- -'), isOffline && React.createElement(ChangeFile, {\n            onClick: this.changeFile\n          }, \"\\u66F4\\u6362\\u4E3A\\u7EBF\\u4E0B\\u5DF2\\u7B7E\\u7F72\\u534F\\u8BAE\"))\n        }]]\n      }), React.createElement(_Modal, {\n        visible: visible,\n        closable: false,\n        onCancel: this.handleCancel,\n        maskClosable: false,\n        destroyOnClose: true,\n        cancelText: \"\\u53D6\\u6D88\",\n        okText: \"\\u786E\\u8BA4\\u6DFB\\u52A0\",\n        onOk: this.handleOk,\n        confirmLoading: btnLoading,\n        okButtonProps: {\n          disabled: buttonVisible\n        }\n      }, React.createElement(Dragger, {\n        onChange: this.getFileList,\n        customRequest: this.customRequest,\n        onRemove: this.onRemove\n      }, React.createElement(\"p\", {\n        className: \"ant-upload-drag-icon\"\n      }, React.createElement(_Icon, {\n        type: \"inbox\"\n      })), React.createElement(\"p\", {\n        className: \"ant-upload-text\"\n      }, \"\\u70B9\\u51FB\\u6216\\u62D6\\u62FD\\u6587\\u4EF6\\u4E0A\\u4F20\"), React.createElement(\"p\", {\n        className: \"ant-upload-hint\"\n      }, \"\\u53EA\\u80FD\\u4E0A\\u4F20\\u4E00\\u4E2A\\u534F\\u8BAE\\u9644\\u4EF6\"))), React.createElement(_Modal, {\n        title: React.createElement(ModalTitle, {\n          iconColor: \"#faad14\",\n          iconType: \"exclamation-circle\",\n          txt: \"\\u5BA1\\u6838\\u63D0\\u793A\"\n        }),\n        visible: codeModal,\n        closable: false,\n        maskClosable: false,\n        onOk: this.create,\n        okText: \"\\u7533\\u8BF7\\u5BA1\\u6838\",\n        confirmLoading: confirmLoading,\n        onCancel: this.hideModal,\n        destroyOnClose: true\n      }, React.createElement(TipText, null, \"\\u2022 \\u7531\\u4E8E\\u4F60\\u66F4\\u6539\\u4E86\\u54A8\\u8BE2\\u65B9\\u6848\\u7684\\u9ED8\\u8BA4\\u9879\\uFF0C\\u9700\\u8981\\u5BA1\\u6838\\u4EBA\\u767B\\u5F55MIS\\u7CFB\\u7EDF\\u5B8C\\u6210\\u6B64\\u670D\\u52A1\\u5355\\u7684\\u5BA1\\u6838\\u3002\"), React.createElement(TipText, null, \"\\u6216\"), React.createElement(TipText, null, \"\\u2022 \\u5982\\u679C\\u5BA1\\u6838\\u4EBA\\u4E0D\\u65B9\\u4FBF\\u767B\\u5F55 MIS \\u7CFB\\u7EDF\\uFF0C\\u4F60\\u53EF\\u4EE5\\u52FE\\u9009\\u201C\\u7533\\u8BF7\\u5BA1\\u6838\\u7801\\u201D\\uFF0C\\u7533\\u8BF7\\u5BA1\\u6838\\u540E\\uFF0C\\u6211\\u4EEC\\u4F1A\\u5C06\\u5BA1\\u6838\\u7801\\u53D1\\u9001\\u53D1\\u9001\\u5230\\u5BA1\\u6838\\u4EBA\\u624B\\u673A\\u4E0A\\u3002\\u8BF7\\u4F60\\u8054\\u7CFB\\u5BF9\\u65B9\\u5E76\\u63CF\\u8FF0\\u672C\\u6B21\\u53D8\\u66F4\\u5185\\u5BB9\\uFF0C\\u5F85\\u5BA1\\u6838\\u4EBA\\u540C\\u610F\\u540E\\uFF0C\\u4F60\\u53EF\\u4EE5\\u5728\\u670D\\u52A1\\u5355\\u8BE6\\u60C5\\u5217\\u4E2D\\u586B\\u5165\\u5BA1\\u6838\\u7801\\uFF0C\\u81EA\\u4E3B\\u5B8C\\u6210\\u5BA1\\u6838\\u3002\"), React.createElement(TipCheck, {\n        onChange: this.isNeedCode\n      }, \"\\u7533\\u8BF7\\u5BA1\\u6838\\u7801\")));\n    }\n  }]);\n\n  return AgreementContainer;\n}(React.Component);\n\nexport default AgreementContainer;\nvar TipText = styled.div.withConfig({\n  displayName: \"AgreementTab__TipText\",\n  componentId: \"cpfmm3-0\"\n})([\"font-size:14px;line-height:22px;color:#172b4d;\"]);\nvar TipCheck = styled(_Checkbox).withConfig({\n  displayName: \"AgreementTab__TipCheck\",\n  componentId: \"cpfmm3-1\"\n})([\"position:absolute;bottom:15px;font-size:14px;line-height:22px;color:#172b4d;\"]);\nvar AgreementWrapper = styled(Item).withConfig({\n  displayName: \"AgreementTab__AgreementWrapper\",\n  componentId: \"cpfmm3-2\"\n})([\"justify-content:space-between;color:#5674bf;\"]);\nvar BtnWrapper = styled(_Button).withConfig({\n  displayName: \"AgreementTab__BtnWrapper\",\n  componentId: \"cpfmm3-3\"\n})([\"font-size:12px;color:#172b4d;\"]);\nvar Text = styled.span.withConfig({\n  displayName: \"AgreementTab__Text\",\n  componentId: \"cpfmm3-4\"\n})([\"color:#ff5230;\"]);\nvar ChangeFile = styled.div.withConfig({\n  displayName: \"AgreementTab__ChangeFile\",\n  componentId: \"cpfmm3-5\"\n})([\"cursor:pointer;\"]);","map":null,"metadata":{},"sourceType":"module"}