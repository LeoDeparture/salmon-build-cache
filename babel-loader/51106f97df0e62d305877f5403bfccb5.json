{"ast":null,"code":"import \"antd/lib/button/style\";\nimport _Button from \"antd/lib/button\";\nimport \"antd/lib/row/style\";\nimport _Row from \"antd/lib/row\";\nimport \"antd/lib/col/style\";\nimport _Col from \"antd/lib/col\";\nimport \"antd/lib/date-picker/style\";\nimport _DatePicker from \"antd/lib/date-picker\";\nimport _toConsumableArray from \"@babel/runtime-corejs2/helpers/esm/toConsumableArray\";\nimport \"antd/lib/form/style\";\nimport _Form from \"antd/lib/form\";\nimport _regeneratorRuntime from \"@babel/runtime-corejs2/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime-corejs2/helpers/esm/asyncToGenerator\";\nimport \"antd/lib/icon/style\";\nimport _Icon from \"antd/lib/icon\";\nimport \"antd/lib/modal/style\";\nimport _Modal from \"antd/lib/modal\";\nimport \"antd/lib/message/style\";\nimport _message from \"antd/lib/message\";\nimport _objectSpread from \"@babel/runtime-corejs2/helpers/esm/objectSpread\";\nimport _classCallCheck from \"@babel/runtime-corejs2/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime-corejs2/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"@babel/runtime-corejs2/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"@babel/runtime-corejs2/helpers/esm/getPrototypeOf\";\nimport _assertThisInitialized from \"@babel/runtime-corejs2/helpers/esm/assertThisInitialized\";\nimport _inherits from \"@babel/runtime-corejs2/helpers/esm/inherits\";\nimport _defineProperty from \"@babel/runtime-corejs2/helpers/esm/defineProperty\";\nimport \"antd/lib/input/style\";\nimport _Input from \"antd/lib/input\";\nimport { compareAsc } from 'date-fns';\nimport moment from 'moment';\nimport Router from 'next/router';\nimport React from 'react';\nimport { ApolloConsumer } from 'react-apollo';\nimport { DetailCommonP } from '../../../../lib/commonCss';\nimport { disablePast, errMessage } from '../../../../lib/commonJs';\nimport { InputRule, NoEmptyOtherRule } from '../../../../lib/commonRule';\nimport { MutationCreatePathwaySession } from '../../containers/Mutations';\nimport { TextAreaAutoSize, Wrapper } from './EditPathway';\nvar TextArea = _Input.TextArea;\n\nvar FormComponent =\n/*#__PURE__*/\nfunction (_React$Component) {\n  _inherits(FormComponent, _React$Component);\n\n  function FormComponent() {\n    var _getPrototypeOf2;\n\n    var _this;\n\n    _classCallCheck(this, FormComponent);\n\n    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n      args[_key] = arguments[_key];\n    }\n\n    _this = _possibleConstructorReturn(this, (_getPrototypeOf2 = _getPrototypeOf(FormComponent)).call.apply(_getPrototypeOf2, [this].concat(args)));\n\n    _defineProperty(_assertThisInitialized(_this), \"state\", {\n      loading: false,\n      templateId: ''\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"mutateSession\", function (fields) {\n      var _this$props = _this.props,\n          onSuccess = _this$props.onSuccess,\n          type = _this$props.type;\n      var pathwayId = Router.query.id;\n\n      if (!pathwayId) {\n        return;\n      }\n\n      _this.setState({\n        loading: true\n      });\n\n      var mutation;\n\n      if (type === 'create') {\n        mutation = MutationCreatePathwaySession;\n      }\n\n      _this.client.mutate({\n        mutation: mutation,\n        variables: {\n          input: _objectSpread({\n            pathwayId: pathwayId\n          }, fields)\n        }\n      }).then(function (_result) {\n        _message.success(type === 'create' ? '已成功创建学习计划阶段' : '已成功保存');\n\n        onSuccess();\n      }).catch(function (error) {\n        if (error.graphQLErrors[0] && error.graphQLErrors[0].data && error.graphQLErrors[0].data.code === 'sessionsStartAtEndAtInvalid') {\n          _this.showTimeConflictAlert();\n\n          _this.setState({\n            loading: false\n          });\n\n          return;\n        }\n\n        errMessage(error);\n\n        _this.setState({\n          loading: false\n        });\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"showTimeConflictAlert\", function () {\n      _Modal.warning({\n        icon: React.createElement(_Icon, {\n          type: \"exclamation-circle\"\n        }),\n        title: '设置失败',\n        content: '该时间段和其他阶段的时间重叠，请调整时间段。',\n        okText: '我知道了'\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"onConfirm\", function () {\n      _this.props.form.validateFieldsAndScroll({\n        force: true\n      },\n      /*#__PURE__*/\n      function () {\n        var _ref = _asyncToGenerator(\n        /*#__PURE__*/\n        _regeneratorRuntime.mark(function _callee(err, fieldsValue) {\n          var type;\n          return _regeneratorRuntime.wrap(function _callee$(_context) {\n            while (1) {\n              switch (_context.prev = _context.next) {\n                case 0:\n                  if (!err) {\n                    type = _this.props.type;\n\n                    if (type === 'create') {\n                      _this.mutateSession(_objectSpread({}, fieldsValue, {\n                        startAt: fieldsValue.startAt && fieldsValue.startAt.startOf('day'),\n                        endAt: fieldsValue.endAt && fieldsValue.endAt.endOf('day')\n                      }));\n                    }\n\n                    if (type === 'edit') {\n                      _this.props.saveInfo(_objectSpread({}, fieldsValue, {\n                        startAt: fieldsValue.startAt && fieldsValue.startAt.startOf('day'),\n                        endAt: fieldsValue.endAt && fieldsValue.endAt.endOf('day')\n                      }));\n                    }\n                  }\n\n                case 1:\n                case \"end\":\n                  return _context.stop();\n              }\n            }\n          }, _callee);\n        }));\n\n        return function (_x, _x2) {\n          return _ref.apply(this, arguments);\n        };\n      }());\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"validateStartAt\", function (_rule, _value, callback) {\n      _this.props.form.validateFieldsAndScroll(['endAt'], {\n        force: true\n      }, function (_err) {\n        return;\n      });\n\n      callback();\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"validateEndAt\", function (_rule, _value, callback) {\n      var getFieldValue = _this.props.form.getFieldValue;\n      var startAt = getFieldValue('startAt');\n      var endAt = getFieldValue('endAt');\n\n      if (compareAsc(startAt, endAt) > 0) {\n        callback('结束日期不可小于开始日期');\n      }\n\n      callback();\n    });\n\n    return _this;\n  }\n\n  _createClass(FormComponent, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      var _this$props2 = this.props,\n          fields = _this$props2.fields,\n          type = _this$props2.type;\n\n      if (type === 'edit') {\n        var startAt = fields.startAt,\n            endAt = fields.endAt;\n\n        var formatedFields = _objectSpread({}, fields, {\n          startAt: startAt && moment(startAt),\n          endAt: endAt && moment(endAt)\n        });\n\n        this.props.form.setFieldsValue(formatedFields);\n      }\n    }\n  }, {\n    key: \"componentWillUnmount\",\n    value: function componentWillUnmount() {\n      this.props.initFields();\n    } // 创建或修改阶段\n\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _this2 = this;\n\n      var getFieldDecorator = this.props.form.getFieldDecorator;\n      var _this$props3 = this.props,\n          type = _this$props3.type,\n          onCancel = _this$props3.onCancel;\n      var loading = this.state.loading;\n      return React.createElement(ApolloConsumer, null, function (client) {\n        _this2.client = client;\n        return React.createElement(Wrapper, null, React.createElement(_Form, null, React.createElement(_Form.Item, {\n          label: \"\\u9636\\u6BB5\\u76EE\\u6807\",\n          colon: false\n        }, getFieldDecorator('purpose', {\n          rules: InputRule\n        })(React.createElement(_Input, {\n          placeholder: \"\\u8BF7\\u8F93\\u5165\\u9636\\u6BB5\\u76EE\\u6807\\uFF0C\\u965064\\u5B57\\u4EE5\\u5185\"\n        }))), React.createElement(_Form.Item, {\n          label: \"\\u76EE\\u6807\\u7B80\\u4ECB\",\n          colon: false\n        }, getFieldDecorator('introduction')(React.createElement(TextArea, {\n          placeholder: \"\\u8BF7\\u8F93\\u5165\\u76EE\\u6807\\u7B80\\u4ECB\",\n          autoSize: TextAreaAutoSize\n        }))), React.createElement(_Form.Item, {\n          colon: false\n        }, React.createElement(\"label\", null, \"\\u5BF9\\u5185\\u5907\\u6CE8\"), React.createElement(DetailCommonP, {\n          style: {\n            margin: '0 12px'\n          }\n        }, \"\\u4EC5\\u5BF9\\u5185\\u53EF\\u89C1\"), getFieldDecorator('remarks')(React.createElement(TextArea, {\n          placeholder: \"\\u8BF7\\u8F93\\u5165\\u5BF9\\u5185\\u5907\\u6CE8\",\n          autoSize: TextAreaAutoSize\n        }))), React.createElement(_Form.Item, {\n          style: {\n            marginBottom: 0\n          },\n          label: \"\\u65F6\\u95F4\\u6BB5\",\n          colon: false,\n          required: true\n        }), React.createElement(_Row, {\n          gutter: 24\n        }, React.createElement(_Col, {\n          span: 12\n        }, React.createElement(_Form.Item, {\n          label: \"\",\n          colon: false\n        }, getFieldDecorator('startAt', {\n          rules: [].concat(_toConsumableArray(NoEmptyOtherRule), [{\n            validator: _this2.validateStartAt\n          }]),\n          validateFirst: true\n        })(React.createElement(_DatePicker, {\n          style: {\n            width: '230px'\n          },\n          placeholder: \"\\u5F00\\u59CB\\u65E5\\u671F\",\n          disabledDate: disablePast\n        })))), React.createElement(_Col, {\n          span: 12\n        }, React.createElement(_Form.Item, {\n          label: \"\",\n          colon: false\n        }, getFieldDecorator('endAt', {\n          rules: [].concat(_toConsumableArray(NoEmptyOtherRule), [{\n            validator: _this2.validateEndAt\n          }]),\n          validateFirst: true\n        })(React.createElement(_DatePicker, {\n          style: {\n            width: '230px'\n          },\n          placeholder: \"\\u7ED3\\u675F\\u65E5\\u671F\",\n          disabledDate: disablePast\n        }))))), React.createElement(_Form.Item, null, React.createElement(_Button, {\n          onClick: onCancel,\n          style: {\n            marginRight: '12px'\n          }\n        }, \"\\u53D6\\u6D88\"), React.createElement(_Button, {\n          onClick: _this2.onConfirm,\n          type: \"primary\",\n          loading: loading\n        }, type === 'create' && '创建阶段', type === 'edit' && '保存'))));\n      });\n    }\n  }]);\n\n  return FormComponent;\n}(React.Component);\n\n_defineProperty(FormComponent, \"defaultProps\", {\n  initFields: function initFields() {},\n  onSuccess: function onSuccess() {},\n  onCancel: function onCancel() {}\n});\n\nvar CreateOrEditSession = _Form.create()(FormComponent);\n\nexport default CreateOrEditSession;","map":null,"metadata":{},"sourceType":"module"}