{"ast":null,"code":"import \"antd/lib/button/style\";\nimport _Button from \"antd/lib/button\";\nimport \"antd/lib/form/style\";\nimport _Form from \"antd/lib/form\";\nimport \"antd/lib/message/style\";\nimport _message from \"antd/lib/message\";\nimport \"antd/lib/badge/style\";\nimport _Badge from \"antd/lib/badge\";\nimport \"antd/lib/avatar/style\";\nimport _Avatar from \"antd/lib/avatar\";\nimport \"antd/lib/icon/style\";\nimport _Icon from \"antd/lib/icon\";\nimport \"antd/lib/modal/style\";\nimport _Modal from \"antd/lib/modal\";\nimport _toConsumableArray from \"@babel/runtime-corejs2/helpers/esm/toConsumableArray\";\nimport _classCallCheck from \"@babel/runtime-corejs2/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime-corejs2/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"@babel/runtime-corejs2/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"@babel/runtime-corejs2/helpers/esm/getPrototypeOf\";\nimport _assertThisInitialized from \"@babel/runtime-corejs2/helpers/esm/assertThisInitialized\";\nimport _inherits from \"@babel/runtime-corejs2/helpers/esm/inherits\";\nimport _defineProperty from \"@babel/runtime-corejs2/helpers/esm/defineProperty\";\nimport TextArea from 'antd/lib/input/TextArea';\nimport debounce from 'lodash/debounce';\nimport Router from 'next/router';\nimport React, { Component } from 'react';\nimport { ApolloConsumer } from 'react-apollo';\nimport styled from 'styled-components';\nimport FilePicker from '../../../../../components/FilePicker';\nimport LimitedInput from '../../../../../components/Input/LimitedInput';\nimport { PageContent } from '../../../../../components/PageLayout';\nimport { LabelDescription, LabelWrapper } from '../../../CSSComponents';\nimport TutorInfoSelect from '../components/TutorInfoSelect';\nimport { MutationCreateSection, MutationUpdateSection } from './Mutations';\nimport { QueryCheckSkillSectionNameDuplication } from './QueryCheckSectionNameDuplication';\nimport { QueryGetSectionById } from './QueryGetSectionById';\n\nvar SectionCreateContainer =\n/*#__PURE__*/\nfunction (_Component) {\n  _inherits(SectionCreateContainer, _Component);\n\n  function SectionCreateContainer(props) {\n    var _this;\n\n    _classCallCheck(this, SectionCreateContainer);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(SectionCreateContainer).call(this, props));\n\n    _defineProperty(_assertThisInitialized(_this), \"setFieldsValue\", _this.props.form.setFieldsValue);\n\n    _defineProperty(_assertThisInitialized(_this), \"goBack\", function () {\n      Router.back();\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"controlAlert\", function (isShow) {\n      _this.setState({\n        validateStatus: isShow ? 'error' : undefined,\n        help: isShow ? '此分类名已被同一级别分类占用，请重新输入' : undefined\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"checkAction\", function (value) {\n      var variables;\n      var id = Router.query.id;\n\n      if (_this.isEdit) {\n        variables = {\n          input: {\n            name: value,\n            id: id\n          }\n        };\n      }\n\n      if (!_this.isEdit) {\n        variables = {\n          input: {\n            name: value,\n            chapterId: id\n          }\n        };\n      }\n\n      _this.client.query({\n        query: QueryCheckSkillSectionNameDuplication,\n        variables: variables\n      }).then(function (v) {\n        if (v.data.result) {\n          _this.controlAlert(v.data.result.status);\n        }\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"onInputText\", function (e) {\n      var value = e.target.value;\n\n      if (!value || value === '') {\n        _this.setState({\n          validateStatus: 'error',\n          help: '当前字段不可为空'\n        });\n\n        return;\n      }\n\n      _this.debounceFunc(value);\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"getFile\", function (type, fileLinks) {\n      var setFieldsValue = _this.props.form.setFieldsValue;\n      var _fileLinks$ = fileLinks[0],\n          id = _fileLinks$.id,\n          file = _fileLinks$.file;\n\n      if (type === 'mediaFile') {\n        _this.setState({\n          mediaFile: [{\n            id: id,\n            file: {\n              file: {\n                filename: file.filename\n              }\n            }\n          }]\n        });\n\n        setFieldsValue({\n          mediaFileDescription: {\n            fileLinkId: id,\n            fileName: file.filename\n          }\n        });\n      }\n\n      if (type === 'allFile') {\n        var prevState = _toConsumableArray(_this.state.allFile);\n\n        var prevVidIds = prevState.map(function (v) {\n          return v.id;\n        });\n        var flatFileLink = fileLinks.filter(function (fl) {\n          return !prevVidIds.includes(fl.file.id);\n        }).map(function (link) {\n          return {\n            id: link.id,\n            filename: link.file.filename\n          };\n        });\n\n        _this.setState({\n          allFile: prevState.concat(flatFileLink)\n        });\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"mentionModal\", function () {\n      _Modal.warning({\n        icon: React.createElement(_Icon, {\n          type: \"exclamation-circle\",\n          theme: \"filled\"\n        }),\n        title: React.createElement(ModalText, null, _this.isEdit ? '无法保存此小节' : '无法创建此小节'),\n        content: React.createElement(ModalText, null, \"\\u5B58\\u5728\\u91CD\\u540D\\u5C0F\\u8282\\uFF0C\\u8BF7\\u66F4\\u6539\\u5C0F\\u8282\\u540D\\u79F0\\u3002\")\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"deselect\", function (vid) {\n      _this.setState(function (prevState) {\n        return {\n          allFile: prevState.allFile.filter(function (vf) {\n            return vf.id !== vid;\n          })\n        };\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"getValue\", function (key, dataJson) {\n      var newData = _toConsumableArray(_this.state.tutorDescriptions);\n\n      newData[key] = {\n        tutor: dataJson\n      };\n\n      _this.setState({\n        tutorDescriptions: newData\n      });\n\n      _this.setFieldsValue(_defineProperty({}, \"tutor[\".concat(key, \"]\"), dataJson.id));\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"tutorBox\", function (data) {\n      var nickname = data.nickname,\n          tutorNo = data.tutorNo,\n          avatar = data.avatar;\n      var badgeStatus = data ? data.inCollaboration ? 'success' : 'default' : 'default';\n      var badgeText = data ? data.inCollaboration ? '正常合作' : '停止合作' : '停止合作';\n      return React.createElement(TutorBoxWrapper, null, avatar ? React.createElement(_Avatar, {\n        src: avatar,\n        size: 48,\n        style: {\n          margin: 10\n        }\n      }) : React.createElement(_Avatar, {\n        src: \"../../../../../../../static/default_avatar.png\",\n        size: 48,\n        style: {\n          margin: 10\n        }\n      }), React.createElement(\"div\", null, React.createElement(FlexStartDiv, null, React.createElement(\"div\", null, nickname ? nickname : ''), React.createElement(\"div\", {\n        style: {\n          marginLeft: '14px'\n        }\n      }, React.createElement(_Badge, {\n        status: badgeStatus,\n        text: badgeText\n      }))), React.createElement(FlexStartDiv, null, React.createElement(TitleP, null, \"ID\\uFF1A\"), React.createElement(TitleP, null, tutorNo ? tutorNo : '')), React.createElement(FlexStartDiv, null, React.createElement(TitleP, {\n        style: {\n          flexShrink: 0\n        }\n      }, \"\\u6700\\u8FD1\\u4E00\\u6B21\\u5DE5\\u4F5C\\u4F01\\u4E1A\\uFF1A\"), React.createElement(TitleP, null, data.lastWorkExperience ? data.lastWorkExperience.foreignCompany ? data.lastWorkExperience.foreignCompany : data.lastWorkExperience.company ? data.lastWorkExperience.company.companyName : '- -' : '- -'))));\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"onClickCreateBtn\", function () {\n      _this.props.form.validateFields(function (err, values) {\n        if (!err) {\n          _this.setState({\n            loading: true\n          });\n\n          var name = values.name,\n              description = values.description,\n              mediaFileDescription = values.mediaFileDescription;\n          var _this$state = _this.state,\n              allFile = _this$state.allFile,\n              tutorDescriptions = _this$state.tutorDescriptions;\n          var mutation;\n          var variables;\n          var mesText; // 编辑状态\n\n          if (_this.isEdit) {\n            var id = Router.query.id;\n            var attachmentIds = allFile.map(function (v) {\n              return {\n                id: v.id\n              };\n            });\n            var tutorInfo = tutorDescriptions.map(function (v) {\n              return {\n                id: v.id,\n                tutorId: v.tutor.id,\n                selfIntroduction: v.description,\n                name: v.tutor.name\n              };\n            });\n            mutation = MutationUpdateSection;\n            variables = {\n              id: id,\n              name: name,\n              description: description,\n              mediaFileDescription: mediaFileDescription,\n              attachmentIds: attachmentIds,\n              tutorDescriptions: tutorInfo\n            };\n            mesText = '已保存成功';\n          } // create 状态\n\n\n          if (!_this.isEdit) {\n            var skillChapterId = Router.query.id;\n\n            var _attachmentIds = allFile.map(function (v) {\n              return {\n                id: v.id\n              };\n            });\n\n            var _tutorInfo = tutorDescriptions.map(function (v) {\n              return {\n                id: v.id,\n                tutorId: v.tutor.id,\n                selfIntroduction: v.description,\n                name: v.tutor.name\n              };\n            });\n\n            variables = {\n              skillChapterId: skillChapterId,\n              name: name,\n              description: description,\n              mediaFileDescription: mediaFileDescription,\n              attachmentIds: _attachmentIds,\n              tutorDescriptions: _tutorInfo\n            };\n            mutation = MutationCreateSection;\n            mesText = '已成功创建小节';\n          }\n\n          _this.client.mutate({\n            mutation: mutation,\n            variables: {\n              input: variables\n            }\n          }).then(function (_) {\n            _message.destroy();\n\n            _message.success(mesText, 1.5, function () {\n              return Router.back();\n            });\n          }).catch(function (_) {\n            _this.setState({\n              loading: false\n            });\n          });\n        }\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"onRef\", function (prop, child) {\n      _this[prop] = child;\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"onClickBtn\", function (type) {\n      _this[type].showPop();\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"remove\", function (k) {\n      var newState = _this.state.tutorDescriptions.filter(function (_, index) {\n        return index !== k;\n      });\n\n      _this.setState({\n        tutorDescriptions: newState\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"addTutor\", function () {\n      var newState = _this.state.tutorDescriptions;\n      newState.push({\n        id: ''\n      });\n\n      _this.setState({\n        tutorDescriptions: newState\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"onTutorDescChange\", function (index, e) {\n      var newState = _toConsumableArray(_this.state.tutorDescriptions);\n\n      newState[index].description = e.target.value;\n\n      _this.setState({\n        tutorDescriptions: newState\n      });\n    });\n\n    _this.state = {\n      loading: false,\n      // 上传文件\n      mediaFile: [],\n      allFile: [],\n      validateStatus: '',\n      help: '',\n      tutorDescriptions: []\n    };\n    return _this;\n  }\n\n  _createClass(SectionCreateContainer, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      var _this2 = this;\n\n      this.isEdit = Router.query.type === 'edit';\n      this.debounceFunc = debounce(this.checkAction, 500);\n\n      if (this.isEdit) {\n        this.client.query({\n          query: QueryGetSectionById,\n          variables: {\n            input: {\n              id: Router.query.id\n            }\n          }\n        }).then(function (v) {\n          if (v.data.section) {\n            var _v$data$section = v.data.section,\n                name = _v$data$section.name,\n                mediaFileDescription = _v$data$section.mediaFileDescription,\n                attachment = _v$data$section.attachment,\n                description = _v$data$section.description,\n                tutorDescriptions = _v$data$section.tutorDescriptions;\n            var file = mediaFileDescription[0].file;\n            var newFilesArr = attachment.map(function (link) {\n              return {\n                id: link.id,\n                filename: link.file && link.file.filename\n              };\n            });\n\n            _this2.props.form.setFieldsValue({\n              name: name,\n              mediaFileDescription: {\n                fileLinkId: file.id,\n                fileName: file.file.filename\n              },\n              description: description\n            });\n\n            _this2.setState({\n              mediaFile: mediaFileDescription,\n              allFile: newFilesArr,\n              tutorDescriptions: tutorDescriptions\n            }, function () {\n              // 导师根据state渲染结束后，回填导师信息\n              tutorDescriptions.forEach(function (value, k) {\n                var _this2$setFieldsValue;\n\n                _this2.setFieldsValue((_this2$setFieldsValue = {}, _defineProperty(_this2$setFieldsValue, \"tutor[\".concat(k, \"]\"), value.id), _defineProperty(_this2$setFieldsValue, \"tutorDesc[\".concat(k, \"]\"), value.selfIntroduction), _this2$setFieldsValue));\n              });\n            });\n          }\n        });\n      }\n    } // 控制提示文案\n\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _this3 = this;\n\n      var getFieldDecorator = this.props.form.getFieldDecorator;\n      var _this$state2 = this.state,\n          loading = _this$state2.loading,\n          mediaFile = _this$state2.mediaFile,\n          allFile = _this$state2.allFile,\n          tutorDescriptions = _this$state2.tutorDescriptions,\n          validateStatus = _this$state2.validateStatus,\n          help = _this$state2.help;\n      return React.createElement(ApolloConsumer, null, function (client) {\n        _this3.client = client;\n        return React.createElement(React.Fragment, null, React.createElement(PageContent, null, React.createElement(Title, null, \"\\u57FA\\u672C\\u4FE1\\u606F\"), React.createElement(_Form, {\n          style: {\n            width: 502\n          }\n        }, React.createElement(_Form.Item, {\n          label: \"\\u5C0F\\u8282\\u540D\\u79F0\",\n          validateStatus: validateStatus,\n          help: help,\n          required: true,\n          colon: false\n        }, getFieldDecorator('name', {\n          rules: [{\n            required: true,\n            message: '当前字段不可为空'\n          }]\n        })(React.createElement(LimitedInput, {\n          placeholder: \"\\u8BF7\\u8F93\\u5165\",\n          limit: 64,\n          onChange: _this3.onInputText\n        }))), React.createElement(_Form.Item, {\n          colon: false,\n          label: React.createElement(LabelWrapper, null, \"\\u5C0F\\u8282\\u5A92\\u4F53\", React.createElement(LabelDescription, null, \"\\u4EC5\\u53EF\\u6DFB\\u52A0 1 \\u4E2A\\u89C6\\u9891/\\u97F3\\u9891/\\u6587\\u6863\\u7C7B\\u578B\\u6587\\u4EF6\"))\n        }, mediaFile.map(function (v) {\n          return React.createElement(MediaFile, {\n            key: v.id\n          }, v.file.file.filename);\n        }), React.createElement(FilePicker, {\n          onRef: _this3.onRef.bind(_this3, 'mediaFile'),\n          fileType: \"media-only\",\n          selectType: \"single\",\n          getSelected: _this3.getFile.bind(_this3, 'mediaFile')\n        }), getFieldDecorator('mediaFileDescription', {\n          rules: [{\n            required: true,\n            message: '当前字段不可为空'\n          }]\n        })(React.createElement(ButtonWrapper, {\n          onClick: _this3.onClickBtn.bind(_this3, 'mediaFile')\n        }, \"\\u9009\\u62E9\\u5A92\\u4F53\"))), React.createElement(_Form.Item, {\n          label: React.createElement(LabelWrapper, null, \"\\u5C0F\\u8282\\u9644\\u4EF6\", React.createElement(LabelDescription, null, \"\\u53EF\\u6DFB\\u52A0\\u4EFB\\u610F\\u7C7B\\u578B\\u591A\\u4E2A\\u6587\\u4EF6\"))\n        }, allFile.map(function (v) {\n          return React.createElement(MediaFile, {\n            key: v.id\n          }, v.filename, React.createElement(\"a\", {\n            onClick: _this3.deselect.bind(_this3, v.id)\n          }, React.createElement(_Icon, {\n            type: \"close\"\n          })));\n        }), React.createElement(FilePicker, {\n          onRef: _this3.onRef.bind(_this3, 'allFile'),\n          fileType: \"all\",\n          selectType: \"multiple\",\n          getSelected: _this3.getFile.bind(_this3, 'allFile')\n        }), getFieldDecorator('attachmentIds')(React.createElement(ButtonWrapper, {\n          onClick: _this3.onClickBtn.bind(_this3, 'allFile')\n        }, \"\\u6DFB\\u52A0\\u9644\\u4EF6\"))), React.createElement(_Form.Item, {\n          colon: false,\n          label: \"\\u5C0F\\u8282\\u7B80\\u4ECB\"\n        }, getFieldDecorator('description')(React.createElement(TextArea, {\n          rows: 3,\n          placeholder: \"\\u4EC5\\u5BF9\\u5185\\u53EF\\u89C1\"\n        }))), React.createElement(Title, null, \"\\u5BFC\\u5E08\\u4FE1\\u606F\"), React.createElement(TutorListWrapper, null, tutorDescriptions.map(function (data, index) {\n          return React.createElement(TutorInfoSelect, {\n            data: data,\n            index: index,\n            key: index,\n            onTutorDescChange: _this3.onTutorDescChange,\n            getValue: _this3.getValue.bind(_this3, index),\n            remove: _this3.remove.bind(_this3, index),\n            tutorBox: _this3.tutorBox,\n            PropForm: _this3.props.form\n          });\n        }), React.createElement(ButtonWrapper, {\n          onClick: _this3.addTutor\n        }, \"\\u6DFB\\u52A0\\u5BFC\\u5E08\")), React.createElement(FooterWrapper, null, React.createElement(_Button, {\n          style: {\n            marginRight: 12\n          },\n          onClick: _this3.goBack\n        }, \"\\u53D6\\u6D88\"), React.createElement(_Button, {\n          type: \"primary\",\n          onClick: _this3.onClickCreateBtn,\n          loading: loading\n        }, _this3.isEdit ? '保存' : '创建课程')))));\n      });\n    }\n  }]);\n\n  return SectionCreateContainer;\n}(Component);\n\nvar CreateSection = _Form.create()(SectionCreateContainer);\n\nexport default CreateSection;\nvar FooterWrapper = styled.div.withConfig({\n  displayName: \"CreateContainer__FooterWrapper\",\n  componentId: \"sc-1qnkc7o-0\"\n})([\"margin:77px 0 59px;\"]);\nvar ButtonWrapper = styled(_Button).withConfig({\n  displayName: \"CreateContainer__ButtonWrapper\",\n  componentId: \"sc-1qnkc7o-1\"\n})([\"width:502px;border:none;border:1px dashed #c3c4d1;\"]);\nvar Title = styled.p.withConfig({\n  displayName: \"CreateContainer__Title\",\n  componentId: \"sc-1qnkc7o-2\"\n})([\"overflow:hidden;font-size:16px;font-weight:500;line-height:28px;color:#172b4d;text-overflow:ellipsis;white-space:nowrap;\"]);\nvar TutorListWrapper = styled.div.withConfig({\n  displayName: \"CreateContainer__TutorListWrapper\",\n  componentId: \"sc-1qnkc7o-3\"\n})([\"width:502px;\"]);\nvar FlexStartDiv = styled.div.withConfig({\n  displayName: \"CreateContainer__FlexStartDiv\",\n  componentId: \"sc-1qnkc7o-4\"\n})([\"display:flex;justify-content:start;\"]);\nvar TitleP = styled.div.withConfig({\n  displayName: \"CreateContainer__TitleP\",\n  componentId: \"sc-1qnkc7o-5\"\n})([\"margin-right:1px;font-size:14px;line-height:24px;opacity:0.5;\"]);\nvar MediaFile = styled.p.withConfig({\n  displayName: \"CreateContainer__MediaFile\",\n  componentId: \"sc-1qnkc7o-6\"\n})([\"margin-bottom:0;font-size:14px;line-height:22px;\"]);\nvar TutorBoxWrapper = styled.div.withConfig({\n  displayName: \"CreateContainer__TutorBoxWrapper\",\n  componentId: \"sc-1qnkc7o-7\"\n})([\"display:flex;padding:12px;background:#f3f4f6;border-radius:4px;\"]);\nvar ModalText = styled.div.withConfig({\n  displayName: \"CreateContainer__ModalText\",\n  componentId: \"sc-1qnkc7o-8\"\n})([\"color:#42526e;\"]);","map":null,"metadata":{},"sourceType":"module"}