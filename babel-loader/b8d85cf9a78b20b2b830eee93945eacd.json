{"ast":null,"code":"import \"antd/lib/spin/style\";\nimport _Spin from \"antd/lib/spin\";\nimport \"antd/lib/breadcrumb/style\";\nimport _Breadcrumb from \"antd/lib/breadcrumb\";\nimport \"antd/lib/alert/style\";\nimport _Alert from \"antd/lib/alert\";\nimport \"antd/lib/button/style\";\nimport _Button from \"antd/lib/button\";\nimport _regeneratorRuntime from \"@babel/runtime-corejs2/regenerator\";\nimport \"antd/lib/icon/style\";\nimport _Icon from \"antd/lib/icon\";\nimport \"antd/lib/modal/style\";\nimport _Modal from \"antd/lib/modal\";\nimport \"antd/lib/message/style\";\nimport _message from \"antd/lib/message\";\nimport _asyncToGenerator from \"@babel/runtime-corejs2/helpers/esm/asyncToGenerator\";\nimport _objectSpread from \"@babel/runtime-corejs2/helpers/esm/objectSpread\";\nimport _classCallCheck from \"@babel/runtime-corejs2/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime-corejs2/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"@babel/runtime-corejs2/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"@babel/runtime-corejs2/helpers/esm/getPrototypeOf\";\nimport _assertThisInitialized from \"@babel/runtime-corejs2/helpers/esm/assertThisInitialized\";\nimport _inherits from \"@babel/runtime-corejs2/helpers/esm/inherits\";\nimport _defineProperty from \"@babel/runtime-corejs2/helpers/esm/defineProperty\";\nimport { format } from 'date-fns';\nimport Link from 'next/link';\nimport Router from 'next/router';\nimport React from 'react';\nimport styled from 'styled-components';\nimport AccountInfoCard from '../../../../components/AccountInfoCard';\nimport PageHeader from '../../../../components/PageLayout/PageHeader';\nimport PathwayStatus from '../../../../components/PathwayStatus';\nimport { breakLine } from '../../../../lib/commonJs';\nimport CONFIG from '../../../../lib/config';\nimport { AlertWrapper } from '../../../pathwayTemplate/components/sessionDetail/SessionDetail';\nimport { BadgeWrapper, Buttons, IconStyle, Info, InfoBody, InfoHeader, Item, ItemContent, ItemTitle, Name, NameWrapper, TableHeader, ToggleWrapper } from '../../../pathwayTemplate/components/templateDetail/TemplateDetail';\nimport { recordToPathwayFields } from '../../commonJs';\nimport ProgressModal from '../../components/progressModal';\nimport CreateSession from './CreateOrEditSession';\nimport CreditTable from './CreditTable';\nimport EditPathway from './EditPathway';\nimport GeneratePathwayModal from './GeneratePathwayModal';\nimport ServiceTicketModal from './ServiceTicketModal';\nimport SessionList from './SessionList';\n\nvar PathwayDetail =\n/*#__PURE__*/\nfunction (_React$Component) {\n  _inherits(PathwayDetail, _React$Component);\n\n  function PathwayDetail(props) {\n    var _this;\n\n    _classCallCheck(this, PathwayDetail);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(PathwayDetail).call(this, props));\n\n    _defineProperty(_assertThisInitialized(_this), \"componentDidMount\", function () {\n      var pathway = _this.props.pathway;\n\n      _this.setState({\n        pathway: pathway\n      }); // 判断是否显示有阶段未发布提示\n\n\n      var hasWithDrewSession = false;\n      pathway.sessions.forEach(function (v) {\n        if (v.isWithdrew) {\n          hasWithDrewSession = true;\n        }\n      });\n\n      _this.setState({\n        alertVisible: hasWithDrewSession && pathway.status.key === 'COMPLETED'\n      }); // 获取额度信息\n\n\n      _this.props.getCreditData().then(function (result) {\n        if (result) {\n          var _result$data$creditDa = result.data.creditData,\n              creditAmount = _result$data$creditDa.creditAmount,\n              plannedAmount = _result$data$creditDa.plannedAmount;\n\n          _this.setState({\n            creditAmount: creditAmount.map(function (v) {\n              return v.amount;\n            }),\n            plannedAmount: plannedAmount.map(function (v) {\n              return v.amount;\n            }),\n            showCreditTable: true\n          });\n        }\n      }).catch(function (error) {\n        // tslint:disable-next-line: no-console\n        console.log(error);\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"toggleInfo\", function () {\n      var infoCollapse = _this.state.infoCollapse;\n\n      _this.setState({\n        infoCollapse: !infoCollapse\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"goBack\", function () {\n      Router.push('/pathway');\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"changeStatus\", function (status) {\n      _this.setState({\n        status: status\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"onSuccess\", function () {\n      _this.setState({\n        status: 0\n      }, _this.props.refetch);\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"saveCreditStatus\", function (creditExceeded, subscriptionExceed) {\n      _this.setState({\n        creditExceeded: creditExceeded,\n        subscriptionExceed: subscriptionExceed\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"onRefServiceTicketModal\", function (ref) {\n      _this.serviceTicketModal = ref;\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"openServiceTicketPop\", function () {\n      _this.serviceTicketModal.showPop();\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"savePathwayInfo\", function (fields) {\n      var pathway = _this.state.pathway;\n\n      _this.setState({\n        pathway: _objectSpread({}, pathway, fields)\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"onRefGeneratePathwayModal\", function (ref) {\n      _this.generatePathwayModal = ref;\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"onClickGenerate\", function () {\n      _this.generatePathwayModal.showPop();\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"showProgressModal\", function (visible) {\n      _this.setState({\n        visible: visible\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"progressDisable\", function (record) {\n      var status = record.status;\n\n      if (status.key === 'UNPLANNED' || status.key === 'PLANNING') {\n        return true;\n      }\n\n      return false;\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"checkEditAuthority\",\n    /*#__PURE__*/\n    function () {\n      var _ref = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee(success) {\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _message.loading('验证权限中...');\n\n                _context.next = 3;\n                return _this.props.checkEditAuthority().then(function (result) {\n                  _message.destroy();\n\n                  var hasAuthority = result.data.result;\n\n                  if (hasAuthority) {\n                    if (success && typeof success === 'function') {\n                      success();\n                    }\n                  } else {\n                    _Modal.warning({\n                      icon: React.createElement(_Icon, {\n                        type: \"exclamation-circle\",\n                        theme: \"filled\"\n                      }),\n                      title: '无法编辑',\n                      content: React.createElement(\"p\", null, \"\\u4F60\\u4E0D\\u662F\\u8BE5\\u8BA1\\u5212\\u7684\\u89C4\\u5212\\u5E08\\uFF0C\\u65E0\\u6CD5\\u7F16\\u8F91\\u8BE5\\u8BA1\\u5212\\u3002\"),\n                      okText: '我知道了',\n                      autoFocusButton: null\n                    });\n                  }\n                }).catch(function () {\n                  _message.destroy();\n\n                  _message.error(CONFIG.txt.noAuth);\n                });\n\n              case 3:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee);\n      }));\n\n      return function (_x) {\n        return _ref.apply(this, arguments);\n      };\n    }());\n\n    _this.state = {\n      status: 0,\n      infoCollapse: true,\n      pathway: null,\n      creditAmount: [],\n      plannedAmount: [],\n      creditExceeded: false,\n      subscriptionExceed: false,\n      showCreditTable: false,\n      alertVisible: false,\n      visible: false\n    };\n    return _this;\n  }\n\n  _createClass(PathwayDetail, [{\n    key: \"render\",\n    value: function render() {\n      var _this$state = this.state,\n          infoCollapse = _this$state.infoCollapse,\n          status = _this$state.status,\n          creditAmount = _this$state.creditAmount,\n          plannedAmount = _this$state.plannedAmount,\n          pathway = _this$state.pathway,\n          creditExceeded = _this$state.creditExceeded,\n          subscriptionExceed = _this$state.subscriptionExceed,\n          showCreditTable = _this$state.showCreditTable,\n          alertVisible = _this$state.alertVisible;\n\n      if (!pathway) {\n        return null;\n      }\n\n      var id = pathway.id,\n          highlights = pathway.highlights,\n          purpose = pathway.purpose,\n          remarks = pathway.remarks,\n          no = pathway.no,\n          studentAccount = pathway.studentAccount,\n          introduction = pathway.introduction,\n          sessions = pathway.sessions,\n          pathwayStatus = pathway.status,\n          startAt = pathway.startAt,\n          endAt = pathway.endAt;\n      var sessionNumber = sessions && sessions.length;\n      var serviceTicketWithPathway = studentAccount.serviceTickets.map(function (t) {\n        return _objectSpread({}, t, {\n          pathway: {\n            id: id,\n            no: no\n          }\n        });\n      }); // 计划周期\n\n      var durationText = '--';\n\n      if (startAt && endAt) {\n        var timeFormat = 'YYYY/MM/DD';\n        durationText = \"\".concat(format(startAt, timeFormat), \" ~ \").concat(format(endAt, timeFormat));\n      }\n\n      if (!status) {\n        var AlertContent = React.createElement(AlertContentWrapper, null, React.createElement(\"span\", null, \"\\u6B64\\u8BA1\\u5212\\u7684\\u9636\\u6BB5\\u53D1\\u751F\\u4E86\\u53D8\\u52A8\\uFF0C\\u5B66\\u5458\\u65E0\\u6CD5\\u67E5\\u770B\\u672A\\u53D1\\u5E03\\u7684\\u9636\\u6BB5\\uFF0C\\u70B9\\u51FB\\u53F3\\u4FA7\\u6309\\u94AE\\u6765\\u53D1\\u5E03\\u4FEE\\u6539\\u3002\"), React.createElement(_Button, {\n          onClick: this.onClickGenerate,\n          type: \"primary\",\n          ghost: true,\n          size: \"small\"\n        }, \"\\u53D1\\u5E03\"));\n        return React.createElement(React.Fragment, null, alertVisible && React.createElement(AlertWrapper, null, React.createElement(_Alert, {\n          message: AlertContent,\n          type: \"info\",\n          showIcon: true,\n          closable: false\n        })), React.createElement(ProgressModal, {\n          visible: this.state.visible,\n          handleCancel: this.showProgressModal.bind(this, !this.state.visible, this.state.pathway),\n          pathway: this.state.pathway\n        }), React.createElement(Info, null, React.createElement(_Breadcrumb, null, React.createElement(_Breadcrumb.Item, null, React.createElement(Link, {\n          href: \"/pathway\"\n        }, React.createElement(\"a\", null, \"\\u5B66\\u4E60\\u8BA1\\u5212\\u7BA1\\u7406\"))), React.createElement(_Breadcrumb.Item, null, \"\\u5B66\\u4E60\\u8BA1\\u5212\\u8BE6\\u60C5\")), React.createElement(InfoHeader, null, React.createElement(NameWrapper, null, React.createElement(Name, null, purpose), React.createElement(BadgeWrapper, null, React.createElement(PathwayStatus, {\n          status: pathwayStatus\n        }))), React.createElement(Buttons, null, React.createElement(ProgressButton, {\n          onClick: this.showProgressModal,\n          show: !this.progressDisable(this.state.pathway)\n        }, \"\\u67E5\\u770B\\u8BFE\\u7A0B\\u8FDB\\u5EA6\"), React.createElement(\"a\", {\n          onClick: this.openServiceTicketPop\n        }, \"\\u67E5\\u770B\\u670D\\u52A1\\u5355\"), React.createElement(ServiceTicketModal, {\n          onRef: this.onRefServiceTicketModal,\n          studentAccount: studentAccount,\n          serviceTicketWithPathway: serviceTicketWithPathway\n        }), React.createElement(_Button, {\n          onClick: this.checkEditAuthority.bind(this, this.changeStatus.bind(this, 1)),\n          style: {\n            marginLeft: '12px'\n          }\n        }, \"\\u7F16\\u8F91\"), pathwayStatus.key !== 'COMPLETED' && React.createElement(_Button, {\n          onClick: this.onClickGenerate,\n          style: {\n            marginLeft: '12px'\n          },\n          type: \"primary\",\n          disabled: !showCreditTable\n        }, \"\\u751F\\u6210\\u5E76\\u53D1\\u5E03\"), React.createElement(GeneratePathwayModal, {\n          onRef: this.onRefGeneratePathwayModal,\n          creditExceeded: creditExceeded,\n          subscriptionExceed: subscriptionExceed,\n          generatePathway: this.props.generatePathway,\n          refetch: this.props.refetch,\n          creditAmount: creditAmount,\n          plannedAmount: plannedAmount\n        }))), React.createElement(InfoBody, null, React.createElement(Item, null, React.createElement(ItemTitle, null, \"\\u8BA1\\u5212\\u5468\\u671F\\uFF1A\"), React.createElement(ItemContent, null, durationText)), React.createElement(Item, null, React.createElement(ItemTitle, null, \"\\u76EE\\u6807\\u7B80\\u4ECB\\uFF1A\"), React.createElement(ItemContent, null, breakLine(introduction))), !infoCollapse && React.createElement(React.Fragment, null, React.createElement(Item, null, React.createElement(ItemTitle, null, \"\\u8BA1\\u5212\\u4EAE\\u70B9\\uFF1A\"), React.createElement(ItemContent, null, breakLine(highlights))), React.createElement(Item, null, React.createElement(ItemTitle, null, \"\\u5BF9\\u5185\\u5907\\u6CE8\\uFF1A\"), React.createElement(ItemContent, null, breakLine(remarks))), React.createElement(Item, null, React.createElement(ItemTitle, null, \"\\u8BA1\\u5212ID\\uFF1A\"), React.createElement(ItemContent, null, no)))), React.createElement(ToggleWrapper, null, React.createElement(\"a\", {\n          onClick: this.toggleInfo\n        }, infoCollapse ? '展开' : '收起', \"\\u66F4\\u591A\\u4FE1\\u606F\", React.createElement(_Icon, {\n          type: infoCollapse ? 'down' : 'up',\n          style: IconStyle\n        })))), React.createElement(Middle, null, React.createElement(MiddleHalf, null, React.createElement(AccountInfoCard, {\n          type: \"student\",\n          studentAccount: studentAccount\n        })), React.createElement(MiddleHalf, null, showCreditTable ? React.createElement(CreditTable, {\n          creditAmount: creditAmount,\n          plannedAmount: plannedAmount,\n          saveCreditStatus: this.saveCreditStatus\n        }) : React.createElement(SpinWrapper, null, React.createElement(_Spin, null)))), React.createElement(Body, null, React.createElement(TableHeader, null, React.createElement(Name, null, \"\\u6B64\\u5B66\\u4E60\\u8BA1\\u5212\\u5185\\u9636\\u6BB5\\uFF08\".concat(sessionNumber, \"\\uFF09\")), React.createElement(Buttons, null, React.createElement(_Button, {\n          onClick: this.checkEditAuthority.bind(this, this.changeStatus.bind(this, 2)),\n          style: {\n            marginLeft: '12px'\n          }\n        }, \"\\u521B\\u5EFA\\u5B66\\u4E60\\u8BA1\\u5212\\u9636\\u6BB5\"))), React.createElement(SessionList, {\n          sessions: sessions,\n          refetch: this.props.refetch\n        })));\n      } // 编辑学习计划基础信息\n\n\n      if (status === 1) {\n        var fields = recordToPathwayFields(pathway);\n        return React.createElement(React.Fragment, null, React.createElement(PageHeader, {\n          titleText: \"\\u7F16\\u8F91\\u5B66\\u4E60\\u8BA1\\u5212\\u57FA\\u7840\\u4FE1\\u606F\"\n        }), React.createElement(Body, null, React.createElement(EditPathway, {\n          fields: fields,\n          onSuccess: this.onSuccess,\n          onCancel: this.changeStatus.bind(this, 0),\n          savePathwayInfo: this.savePathwayInfo,\n          durationText: durationText\n        })));\n      } // 创建学习计划阶段\n\n\n      if (status === 2) {\n        return React.createElement(React.Fragment, null, React.createElement(PageHeader, {\n          titleText: \"\\u521B\\u5EFA\\u5B66\\u4E60\\u8BA1\\u5212\\u9636\\u6BB5\"\n        }), React.createElement(Body, null, React.createElement(CreateSession, {\n          type: \"create\",\n          onSuccess: this.onSuccess,\n          onCancel: this.changeStatus.bind(this, 0),\n          sessions: sessions\n        })));\n      }\n\n      return null;\n    }\n  }]);\n\n  return PathwayDetail;\n}(React.Component);\n\nexport default PathwayDetail;\nvar ProgressButton = styled.a.withConfig({\n  displayName: \"PathwayDetail__ProgressButton\",\n  componentId: \"sc-1hffm9w-0\"\n})([\"display:\", \";margin-right:16px;\"], function (props) {\n  return props.show ? '' : 'none';\n});\nvar Middle = styled.div.withConfig({\n  displayName: \"PathwayDetail__Middle\",\n  componentId: \"sc-1hffm9w-1\"\n})([\"display:flex;margin:24px 24px 0 24px;\"]);\nvar MiddleHalf = styled.div.withConfig({\n  displayName: \"PathwayDetail__MiddleHalf\",\n  componentId: \"sc-1hffm9w-2\"\n})([\"flex:1;padding:24px 42px;background-color:#fff;&:first-child{margin-right:12px;}&:last-child{margin-left:12px;}\"]);\nvar Body = styled.div.withConfig({\n  displayName: \"PathwayDetail__Body\",\n  componentId: \"sc-1hffm9w-3\"\n})([\"flex:1;min-height:400px;margin:24px;background-color:#fff;\"]);\nvar SpinWrapper = styled.div.withConfig({\n  displayName: \"PathwayDetail__SpinWrapper\",\n  componentId: \"sc-1hffm9w-4\"\n})([\"display:flex;align-items:center;justify-content:center;width:100%;height:100%;\"]);\nvar AlertContentWrapper = styled.div.withConfig({\n  displayName: \"PathwayDetail__AlertContentWrapper\",\n  componentId: \"sc-1hffm9w-5\"\n})([\"display:flex;justify-content:space-between;\"]);","map":null,"metadata":{},"sourceType":"module"}