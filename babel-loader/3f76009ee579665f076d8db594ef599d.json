{"ast":null,"code":"import \"antd/lib/spin/style\";\nimport _Spin from \"antd/lib/spin\";\nimport \"antd/lib/menu/style\";\nimport _Menu from \"antd/lib/menu\";\nimport \"antd/lib/modal/style\";\nimport _Modal from \"antd/lib/modal\";\nimport _toConsumableArray from \"@babel/runtime-corejs2/helpers/esm/toConsumableArray\";\nimport _regeneratorRuntime from \"@babel/runtime-corejs2/regenerator\";\nimport _Object$assign from \"@babel/runtime-corejs2/core-js/object/assign\";\nimport _asyncToGenerator from \"@babel/runtime-corejs2/helpers/esm/asyncToGenerator\";\nimport _Promise from \"@babel/runtime-corejs2/core-js/promise\";\nimport \"antd/lib/message/style\";\nimport _message from \"antd/lib/message\";\nimport _classCallCheck from \"@babel/runtime-corejs2/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime-corejs2/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"@babel/runtime-corejs2/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"@babel/runtime-corejs2/helpers/esm/getPrototypeOf\";\nimport _assertThisInitialized from \"@babel/runtime-corejs2/helpers/esm/assertThisInitialized\";\nimport _inherits from \"@babel/runtime-corejs2/helpers/esm/inherits\";\nimport _defineProperty from \"@babel/runtime-corejs2/helpers/esm/defineProperty\";\nimport Link from 'next/link';\nimport React from 'react';\nimport Loading from '../../../../components/Loading';\nimport { formatToAsia } from '../../../../lib/date';\nimport { handleConfirmOtherError } from '../../../../lib/handleError';\nimport PrivateCourseManagementContent from '../components/PrivateCourseManagementContent';\nimport { MutationDisablePrivateCourse, MutationEnablePrivateCourse, MutationRemovePrivateCourse, sortPrivateCoursesMutation } from './MutationPrivateCourse';\nimport QueryListPrivateCourses, { listPrivateCoursesQuery } from './QueryListPrivateCourses';\nvar getDataNumber = 20;\nexport var listPrivateCoursesVariable = {\n  input: {\n    first: getDataNumber,\n    orderBy: this ? this.state.orderBy : 'createdAt_ASC',\n    where: {\n      courseCategory: {\n        id: this ? this.state.idFilter : undefined\n      }\n    }\n  }\n};\n\nvar PrivateCourseManagementContainer =\n/*#__PURE__*/\nfunction (_React$Component) {\n  _inherits(PrivateCourseManagementContainer, _React$Component);\n\n  function PrivateCourseManagementContainer() {\n    var _getPrototypeOf2;\n\n    var _this;\n\n    _classCallCheck(this, PrivateCourseManagementContainer);\n\n    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n      args[_key] = arguments[_key];\n    }\n\n    _this = _possibleConstructorReturn(this, (_getPrototypeOf2 = _getPrototypeOf(PrivateCourseManagementContainer)).call.apply(_getPrototypeOf2, [this].concat(args)));\n\n    _defineProperty(_assertThisInitialized(_this), \"state\", {\n      endPageData: true,\n      idFilter: undefined,\n      loading: false,\n      orderBy: 'createdAt_ASC',\n      pageInfo: {\n        endCursor: '',\n        hasNextPage: true,\n        startCursor: '',\n        hasPreviousPage: false\n      },\n      showTable: true\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"getCourseCategoryNameString\", function (courseCategory) {\n      var current = courseCategory;\n      var courseCategoriesArr = [];\n\n      while (current && current.name) {\n        courseCategoriesArr.push(current.name);\n        current = current.parent;\n      }\n\n      courseCategoriesArr.reverse();\n      var full = courseCategoriesArr.join(' / ');\n      return full.length > 15 ? '...' + full.slice(-15) : full;\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"renderMessage\", function (mutation, error) {\n      if (mutation === MutationRemovePrivateCourse) {\n        if (error) {\n          _message.success('已成功移除此1对1课程');\n\n          return;\n        }\n\n        _message.error('移除1对1课程失败');\n\n        return;\n      }\n\n      if (mutation === MutationDisablePrivateCourse) {\n        if (error) {\n          _message.success('已成功下线此1对1课程');\n\n          return;\n        }\n\n        _message.error('下线1对1课程失败');\n\n        return;\n      }\n\n      if (mutation === MutationEnablePrivateCourse) {\n        if (error) {\n          _message.success('已成功上线此1对1课程');\n\n          return;\n        }\n\n        _message.error('上线1对1课程失败');\n\n        return;\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"handleSortConfirm\", function (sortItems) {\n      var variable = {\n        input: {\n          idPositions: sortItems\n        }\n      };\n      return _this.client.mutate({\n        variables: variable,\n        mutation: sortPrivateCoursesMutation\n      }).then(function (res) {\n        _this.refetch(listPrivateCoursesVariable);\n\n        _message.success('已成功排序');\n\n        return res;\n      }).catch(function (e) {\n        if (handleConfirmOtherError(e)) {\n          _message.error('排序失败');\n        }\n\n        return _Promise.reject(e);\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"handleFetchSortList\", function () {\n      return _this.client.query({\n        // tslint:disable-next-line\n        fetchPolicy: 'network-only',\n        query: listPrivateCoursesQuery,\n        variables: {\n          input: {\n            orderBy: 'sort_ASC',\n            where: {\n              courseCategory: {\n                id: _this.state.idFilter\n              }\n            }\n          }\n        }\n      }).then(function (res) {\n        var data = res.data.listPrivateCoursesWithPagination.edges;\n        return data.map(function (item) {\n          return item.node;\n        });\n      }).catch(function (e) {\n        if (handleConfirmOtherError(e)) {\n          _message.error('操作失败');\n        }\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"handleMutation\",\n    /*#__PURE__*/\n    function () {\n      var _ref = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee(variables, mutation) {\n        var deleteFilterFun, opts, updateOpt;\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                deleteFilterFun = function _ref2(data, result2) {\n                  data.listPrivateCoursesWithPagination.edges.forEach(function (item, index) {\n                    if (item.node.id === result2.data.removePrivateCourse.id) {\n                      data.listPrivateCoursesWithPagination.edges.splice(index, 1);\n                    }\n                  });\n                  return data;\n                };\n\n                opts = {\n                  mutation: mutation,\n                  variables: variables\n                };\n\n                if (mutation === MutationRemovePrivateCourse) {\n                  updateOpt = function updateOpt(proxy, result2) {\n                    // @ts-ignore\n                    var data = proxy.readQuery({\n                      query: listPrivateCoursesQuery,\n                      variables: listPrivateCoursesVariable\n                    });\n                    var data2 = deleteFilterFun(data, result2);\n                    proxy.writeQuery({\n                      data: data2,\n                      query: listPrivateCoursesQuery,\n                      variables: listPrivateCoursesVariable\n                    });\n                  };\n\n                  _Object$assign(opts, {\n                    update: updateOpt\n                  });\n                }\n\n                return _context.abrupt(\"return\", _this.client.mutate(opts).then(function () {\n                  _this.renderMessage(mutation, true);\n                }).catch(function (e) {\n                  if (handleConfirmOtherError(e)) {\n                    _this.renderMessage(mutation, false);\n                  }\n                }));\n\n              case 4:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee);\n      }));\n\n      return function (_x, _x2) {\n        return _ref.apply(this, arguments);\n      };\n    }());\n\n    _defineProperty(_assertThisInitialized(_this), \"handleQueryMore\",\n    /*#__PURE__*/\n    _asyncToGenerator(\n    /*#__PURE__*/\n    _regeneratorRuntime.mark(function _callee2() {\n      return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              if (!(_this.state.pageInfo.hasNextPage && !_this.state.loading)) {\n                _context2.next = 5;\n                break;\n              }\n\n              _this.setState({\n                loading: true\n              });\n\n              _context2.next = 4;\n              return _this.fetchMore({\n                updateQuery: function updateQuery(prev, _ref4) {\n                  var fetchMoreResult = _ref4.fetchMoreResult;\n\n                  if (!fetchMoreResult) {\n                    return prev;\n                  }\n\n                  var prevData = prev.listPrivateCoursesWithPagination.edges;\n                  var fetchResult = fetchMoreResult.listPrivateCoursesWithPagination.edges;\n                  fetchMoreResult.listPrivateCoursesWithPagination.edges = [].concat(_toConsumableArray(prevData), _toConsumableArray(fetchResult));\n                  return fetchMoreResult;\n                },\n                variables: {\n                  input: {\n                    after: _this.state.pageInfo.endCursor,\n                    first: getDataNumber,\n                    orderBy: _this.state.orderBy,\n                    where: {\n                      courseCategory: {\n                        id: _this.state.idFilter\n                      }\n                    }\n                  }\n                }\n              }).then(function (result) {\n                if (result.data) {\n                  _this.setListData('getMore', result.data);\n\n                  _this.setState({\n                    loading: false\n                  });\n                }\n              }).catch(function () {\n                _message.error('加载失败！');\n              });\n\n            case 4:\n              return _context2.abrupt(\"return\");\n\n            case 5:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _callee2);\n    })));\n\n    _defineProperty(_assertThisInitialized(_this), \"renderModal\", function (row, showHoverData) {\n      var variable = {\n        input: {\n          id: row.id\n        }\n      };\n      var props = {\n        cancelText: '取消',\n        centered: true,\n        iconType: showHoverData === '移除' ? 'delete' : 'exclamation-circle',\n        okText: \"\\u786E\\u8BA4\".concat(showHoverData),\n        okType: showHoverData === '移除' ? 'danger' : 'primary',\n        title: \"\\u786E\\u8BA4\\u8981\".concat(showHoverData, \"\\u6B641\\u5BF91\\u8F85\\u5BFC\\u5417\\uFF1F\")\n      };\n\n      if (showHoverData === '上线') {\n        props.content = '';\n        props.onOk = _this.handleMutation.bind(_assertThisInitialized(_this), variable, MutationEnablePrivateCourse);\n      } else if (showHoverData === '下线') {\n        props.content = React.createElement(\"div\", {\n          style: {\n            fontSize: '13px'\n          }\n        }, React.createElement(\"p\", null, \"\\u4E0B\\u7EBF\\u6B641\\u5BF91\\u8F85\\u5BFC\\u540E\\uFF1A\"), React.createElement(\"ol\", null, React.createElement(\"li\", null, \"\\u672A\\u9884\\u7EA6\\u7684\\u7528\\u6237\\u5C06\\u65E0\\u6CD5\\u770B\\u5F85\\u8BE51\\u5BF91\\u8F85\\u5BFC\\u5E76\\u9884\\u7EA6\\uFF1B\"), React.createElement(\"li\", null, \"\\u5DF2\\u9884\\u7EA6\\u6210\\u529F\\u7684\\u7528\\u6237\\u9700\\u8981\\u7EE7\\u7EED\\u5B8C\\u6210\\u5C65\\u7EA6\\uFF1B\"), React.createElement(\"li\", null, \"MIS \\u7CFB\\u7EDF\\u5185\\u53EF\\u4EE5\\u88AB\\u770B\\u5230\\uFF0C\\u4F46\\u65E0\\u6CD5\\u88AB\\u5E94\\u7528\\u5230\\u4E1A\\u52A1\\uFF1B\"), React.createElement(\"li\", null, \"\\u4E0B\\u7EBF\\u540E\\u76841\\u5BF91\\u8F85\\u5BFC\\u53EF\\u4EE5\\u91CD\\u65B0\\u4E0A\\u7EBF\\u3002\")));\n        props.onOk = _this.handleMutation.bind(_assertThisInitialized(_this), variable, MutationDisablePrivateCourse);\n      } else if (showHoverData === '移除') {\n        props.content = React.createElement(\"div\", {\n          style: {\n            fontSize: '13px'\n          }\n        }, React.createElement(\"p\", null, \"\\u79FB\\u9664\\u6B641\\u5BF91\\u8F85\\u5BFC\\u540E\\uFF1A\"), React.createElement(\"ol\", null, React.createElement(\"li\", null, \"\\u672A\\u9884\\u7EA6\\u7684\\u7528\\u6237\\u5C06\\u65E0\\u6CD5\\u770B\\u5F85\\u8BE51\\u5BF91\\u8F85\\u5BFC\\u5E76\\u9884\\u7EA6\\uFF1B\"), React.createElement(\"li\", null, \"\\u5DF2\\u9884\\u7EA6\\u6210\\u529F\\u7684\\u7528\\u6237\\u9700\\u8981\\u7EE7\\u7EED\\u5B8C\\u6210\\u5C65\\u7EA6\\uFF1B\"), React.createElement(\"li\", null, \"MIS \\u7CFB\\u7EDF\\u5185\\u7528\\u6237\\u65E0\\u6CD5\\u67E5\\u770B\\u5230\\u8BE51\\u5BF91\\u8F85\\u5BFC\\uFF1B\"), React.createElement(\"li\", null, \"\\u79FB\\u9664\\u540E\\u76841\\u5BF91\\u8F85\\u5BFC\\u65E0\\u6CD5\\u518D\\u6B21\\u4E0A\\u7EBF\\u3002\")));\n        props.onOk = _this.handleMutation.bind(_assertThisInitialized(_this), variable, MutationRemovePrivateCourse);\n      }\n\n      _Modal.confirm(props);\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"renderMenu\", function (showHoverData, record) {\n      return showHoverData.map(function (item, index) {\n        if (item === '查看详情') {\n          return React.createElement(_Menu.Item, null, React.createElement(Link, {\n            href: \"/private-course-details?id=\".concat(record.id)\n          }, React.createElement(\"span\", null, \"\\u67E5\\u770B\\u8BE6\\u60C5\")));\n        }\n\n        if (item === '编辑') {\n          return React.createElement(_Menu.Item, null, React.createElement(Link, {\n            href: \"/private-course-details?id=\".concat(record.id, \"&edit\")\n          }, React.createElement(\"span\", null, \"\\u7F16\\u8F91\")));\n        }\n\n        if (item === '上线' || item === '下线') {\n          return React.createElement(_Menu.Item, {\n            key: index\n          }, React.createElement(\"a\", {\n            onClick: _this.renderModal.bind(_assertThisInitialized(_this), record, item)\n          }, item));\n        }\n\n        if (item === '移除') {\n          return React.createElement(_Menu.Item, {\n            key: index\n          }, React.createElement(\"a\", {\n            style: {\n              color: 'red'\n            },\n            onClick: _this.renderModal.bind(_assertThisInitialized(_this), record, item)\n          }, item));\n        }\n\n        return null;\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"renderFooter\", function (Icon, LoadingA, LoadingDiv) {\n      var antIcon = React.createElement(Icon, {\n        type: \"loading\",\n        style: {\n          fontSize: 10\n        },\n        spin: true\n      });\n      return React.createElement(\"div\", null, _this.state.pageInfo.hasNextPage ? React.createElement(LoadingDiv, null, React.createElement(LoadingA, {\n        onClick: _this.handleQueryMore\n      }, \"\\u70B9\\u51FB\\u52A0\\u8F7D\\u66F4\\u591A\"), _this.state.loading ? React.createElement(_Spin, {\n        indicator: antIcon\n      }) : React.createElement(\"div\", null)) : React.createElement(\"div\", null));\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"setListData\", function (type, data) {\n      var id = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : undefined;\n      var order = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : 'createdAt_ASC';\n      var listData = [];\n\n      if (!data.listPrivateCoursesWithPagination) {\n        _this.setState({\n          pageInfo: {\n            endCursor: '',\n            hasNextPage: false,\n            startCursor: '',\n            hasPreviousPage: false\n          }\n        });\n      }\n\n      var dataArr = data.listPrivateCoursesWithPagination.edges;\n\n      if (dataArr.length) {\n        dataArr.map(function (item) {\n          listData.push({\n            category: _this.getCourseCategoryNameString(item.node.courseCategory),\n            createdAt: formatToAsia(item.node.createdAt, 'YYYY/MM/DD HH:mm'),\n            id: item.node.id,\n            industry: item.node.industry.name,\n            key: item.node.id,\n            name: item.node.name,\n            operating: '选择操作',\n            status: item.node.status.name\n          });\n        });\n      }\n\n      if (type === 'modifyState') {\n        _this.setState({\n          orderBy: order,\n          idFilter: id\n        });\n      }\n\n      if (type === 'handleData') {\n        return listData;\n      }\n\n      var pageInfo = data.listPrivateCoursesWithPagination.pageInfo;\n\n      _this.setState({\n        pageInfo: pageInfo\n      });\n\n      return listData;\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"setListDataWithFilter\",\n    /*#__PURE__*/\n    function () {\n      var _ref5 = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee3(id) {\n        var order, result;\n        return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                order = id ? 'sort_ASC' : 'createdAt_ASC';\n                listPrivateCoursesVariable.input.where.courseCategory.id = id;\n                listPrivateCoursesVariable.input.orderBy = order;\n\n                _this.setState({\n                  showTable: false\n                });\n\n                _context3.next = 6;\n                return _this.client.query({\n                  query: listPrivateCoursesQuery,\n                  variables: listPrivateCoursesVariable,\n                  fetchPolicy: 'network-only'\n                });\n\n              case 6:\n                result = _context3.sent;\n\n                _this.setState({\n                  showTable: true\n                });\n\n                _this.setListData('modifyState', result.data, id, order);\n\n              case 9:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3);\n      }));\n\n      return function (_x3) {\n        return _ref5.apply(this, arguments);\n      };\n    }());\n\n    _defineProperty(_assertThisInitialized(_this), \"setListDataWithSorter\",\n    /*#__PURE__*/\n    function () {\n      var _ref6 = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee4(antdOrder) {\n        var order, result;\n        return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                order = antdOrder === 'descend' ? 'createdAt_DESC' : !antdOrder && _this.state.idFilter ? 'sort_ASC' : 'createdAt_ASC';\n                listPrivateCoursesVariable.input.orderBy = order;\n                _context4.next = 4;\n                return _this.client.query({\n                  query: listPrivateCoursesQuery,\n                  variables: listPrivateCoursesVariable,\n                  fetchPolicy: 'network-only'\n                });\n\n              case 4:\n                result = _context4.sent;\n\n                _this.setListData('modifyState', result.data, _this.state.idFilter, order);\n\n              case 6:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4);\n      }));\n\n      return function (_x4) {\n        return _ref6.apply(this, arguments);\n      };\n    }());\n\n    return _this;\n  }\n\n  _createClass(PrivateCourseManagementContainer, [{\n    key: \"componentWillUnmount\",\n    value: function componentWillUnmount() {\n      listPrivateCoursesVariable.input.where.courseCategory.id = undefined;\n      listPrivateCoursesVariable.input.orderBy = 'createdAt_ASC';\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _this2 = this;\n\n      return React.createElement(QueryListPrivateCourses, {\n        query: listPrivateCoursesQuery,\n        variables: listPrivateCoursesVariable,\n        onCompleted: this.setListData.bind(this, 'listData'),\n        fetchPolicy: \"network-only\"\n      }, function (_ref7) {\n        var data = _ref7.data,\n            error = _ref7.error,\n            loading = _ref7.loading,\n            refetch = _ref7.refetch,\n            client = _ref7.client,\n            fetchMore = _ref7.fetchMore;\n        _this2.refetch = refetch;\n        _this2.client = client;\n        _this2.fetchMore = fetchMore;\n\n        if (loading) {\n          return React.createElement(Loading, null);\n        }\n\n        if (error) {\n          return null;\n        }\n\n        return React.createElement(PrivateCourseManagementContent, {\n          listData: _this2.setListData('handleData', data),\n          footer: _this2.renderFooter,\n          menuItem: _this2.renderMenu,\n          filterHandler: _this2.setListDataWithFilter,\n          orderHandler: _this2.setListDataWithSorter,\n          getListItemsHelper: _this2.handleFetchSortList,\n          setListItemsHelper: _this2.handleSortConfirm,\n          showTable: _this2.state.showTable\n        });\n      });\n    }\n  }]);\n\n  return PrivateCourseManagementContainer;\n}(React.Component);\n\nexport default PrivateCourseManagementContainer;","map":null,"metadata":{},"sourceType":"module"}