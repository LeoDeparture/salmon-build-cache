{"ast":null,"code":"import \"antd/lib/button/style\";\nimport _Button from \"antd/lib/button\";\nimport \"antd/lib/input/style\";\nimport _Input from \"antd/lib/input\";\nimport \"antd/lib/tag/style\";\nimport _Tag from \"antd/lib/tag\";\nimport \"antd/lib/date-picker/style\";\nimport _DatePicker from \"antd/lib/date-picker\";\nimport \"antd/lib/form/style\";\nimport _Form from \"antd/lib/form\";\nimport _toConsumableArray from \"@babel/runtime-corejs2/helpers/esm/toConsumableArray\";\nimport \"antd/lib/message/style\";\nimport _message from \"antd/lib/message\";\nimport _objectSpread from \"@babel/runtime-corejs2/helpers/esm/objectSpread\";\nimport \"antd/lib/icon/style\";\nimport _Icon from \"antd/lib/icon\";\nimport \"antd/lib/modal/style\";\nimport _Modal from \"antd/lib/modal\";\nimport _classCallCheck from \"@babel/runtime-corejs2/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime-corejs2/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"@babel/runtime-corejs2/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"@babel/runtime-corejs2/helpers/esm/getPrototypeOf\";\nimport _assertThisInitialized from \"@babel/runtime-corejs2/helpers/esm/assertThisInitialized\";\nimport _inherits from \"@babel/runtime-corejs2/helpers/esm/inherits\";\nimport _defineProperty from \"@babel/runtime-corejs2/helpers/esm/defineProperty\";\nimport TextArea from 'antd/lib/input/TextArea';\nimport moment from 'moment';\nimport Router from 'next/router';\nimport React, { Component } from 'react';\nimport styled from 'styled-components';\nimport { ApolloConsumer } from 'react-apollo';\nimport FilePicker from '../../../../../components/FilePicker';\nimport LimitedInput from '../../../../../components/Input/LimitedInput';\nimport RichTextEditor from '../../../../../components/RichTextEditor';\nimport { parseErrorCode } from '../../../../../lib/commonJs';\nimport { LabelDescription, LabelWrapper } from '../../../CSSComponents';\nimport { MutationCreateSeries, MutationUpdateSeries } from './Mutation';\nimport { QueryGetSeriesById } from './QueryGetSeriesById';\n\nvar CreateOrEditContainer =\n/*#__PURE__*/\nfunction (_Component) {\n  _inherits(CreateOrEditContainer, _Component);\n\n  function CreateOrEditContainer(props) {\n    var _this;\n\n    _classCallCheck(this, CreateOrEditContainer);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(CreateOrEditContainer).call(this, props));\n\n    _defineProperty(_assertThisInitialized(_this), \"goBack\", function () {\n      Router.back();\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"mentionModal\", function () {\n      var type = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : undefined;\n      var title = '无法创建此周期';\n      var text = '存在重名周期，请更改周期名称';\n\n      if (_this.isEdit) {\n        title = '无法编辑此周期';\n      }\n\n      if (type === 'hasSameTime') {\n        title = '无法创建此周期';\n        text = '该时段已被占用，请更改时段。';\n      }\n\n      _Modal.warning({\n        icon: React.createElement(_Icon, {\n          type: \"exclamation-circle\",\n          theme: \"filled\"\n        }),\n        title: React.createElement(\"div\", {\n          style: {\n            color: '#42526E'\n          }\n        }, title),\n        content: React.createElement(\"div\", {\n          style: {\n            color: '#42526E'\n          }\n        }, text)\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"onClickCreateBtn\", function () {\n      _this.props.form.validateFields(function (err, values) {\n        if (!err) {\n          var name = values.name,\n              startAt = values.startAt,\n              endAt = values.endAt,\n              courseHighlights = values.courseHighlights;\n          var _this$state = _this.state,\n              description = _this$state.description,\n              suitableCrowd = _this$state.suitableCrowd,\n              tutorIntroduction = _this$state.tutorIntroduction,\n              tags = _this$state.tags,\n              introFile = _this$state.introFile,\n              contentFile = _this$state.contentFile,\n              videoFile = _this$state.videoFile;\n\n          _this.setState({\n            loading: true\n          });\n\n          var formatVariables = {\n            name: name,\n            startAt: new Date(startAt).toISOString(),\n            endAt: new Date(endAt).toISOString(),\n            pictureUrl: introFile,\n            courseContentPicUrl: contentFile,\n            videoUrl: videoFile.map(function (v) {\n              return {\n                id: v.id\n              };\n            }),\n            courseHighlights: courseHighlights,\n            description: description && description.toHTML(),\n            suitableCrowd: suitableCrowd && suitableCrowd.toHTML(),\n            tutorIntroduction: tutorIntroduction && tutorIntroduction.toHTML(),\n            tags: tags\n          };\n          var mutation;\n          var variables;\n          var mesText; // 编辑状态\n\n          if (_this.isEdit) {\n            var queryId = Router.query.itemId;\n            mutation = MutationUpdateSeries;\n            variables = _objectSpread({\n              id: queryId\n            }, formatVariables);\n            mesText = '已保存成功';\n          } // clone 状态和 create 状态\n\n\n          if (!_this.isEdit) {\n            var courseProductId = Router.query.id;\n            variables = _objectSpread({\n              courseProductId: courseProductId\n            }, formatVariables);\n            mutation = MutationCreateSeries;\n            mesText = '已成功创建周期';\n          }\n\n          _this.client.mutate({\n            mutation: mutation,\n            variables: {\n              input: variables\n            }\n          }).then(function (_) {\n            _message.destroy();\n\n            _message.success(mesText, 1.5, function () {\n              return Router.back();\n            });\n          }).catch(function (error) {\n            if (parseErrorCode(error) === 'DuplicationError') {\n              _this.mentionModal();\n            }\n\n            if (parseErrorCode(error) === 'PeriodOverlapped') {\n              _this.mentionModal('hasSameTime');\n            }\n\n            _this.setState({\n              loading: false\n            });\n          });\n        }\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"getFile\", function (type, fileLinks) {\n      var setFieldsValue = _this.props.form.setFieldsValue;\n      var resultUrl = fileLinks[0].file.transformedFile.url;\n\n      if (type === 'introFile') {\n        _this.setState({\n          introFile: resultUrl\n        });\n\n        setFieldsValue({\n          pictureUrl: resultUrl\n        });\n      }\n\n      if (type === 'contentFile') {\n        _this.setState({\n          contentFile: resultUrl\n        });\n\n        setFieldsValue({\n          courseContentPicUrl: resultUrl\n        });\n      }\n\n      if (type === 'videoFile') {\n        var prevState = _toConsumableArray(_this.state.videoFile);\n\n        var prevVidIds = prevState.map(function (v) {\n          return v.id;\n        });\n        var flatFileLink = fileLinks.filter(function (fl) {\n          return !prevVidIds.includes(fl.file.id);\n        }).map(function (link) {\n          return {\n            id: link.file.id,\n            filename: link.file.filename\n          };\n        });\n\n        _this.setState({\n          videoFile: prevState.concat(flatFileLink)\n        });\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"onClickBtn\", function (type) {\n      _this[type].showPop();\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"onRef\", function (prop, child) {\n      _this[prop] = child;\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"disabledStartDate\", function (startAtValue) {\n      var endAtValue = _this.state.endAtValue;\n\n      if (!startAtValue || !endAtValue) {\n        return startAtValue && startAtValue.isBefore(moment(), 'day');\n      }\n\n      return startAtValue && startAtValue.isBefore(moment(), 'day') || startAtValue.isAfter(endAtValue, 'day');\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"disabledEndDate\", function (endAtValue) {\n      var startAtValue = _this.state.startAtValue;\n\n      if (!endAtValue || !startAtValue) {\n        return endAtValue && endAtValue.isBefore(moment(), 'day');\n      }\n\n      return endAtValue && endAtValue.isBefore(startAtValue, 'day');\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"onChange\", function (field, value) {\n      _this.setState(_defineProperty({}, field, value));\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"onStartChange\", function (value) {\n      _this.onChange('startAtValue', value);\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"onEndChange\", function (value) {\n      _this.onChange('endAtValue', value);\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"deselect\", function (vid) {\n      _this.setState(function (prevState) {\n        return {\n          videoFile: prevState.videoFile.filter(function (vf) {\n            return vf.id !== vid;\n          })\n        };\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"handleFieldChange\", function (stateName, stateValue) {\n      _this.setState(_defineProperty({}, stateName, stateValue));\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"saveInputRef\", function (input) {\n      _this.tagInput = input;\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"showInput\", function () {\n      _this.setState({\n        inputVisible: true\n      }, function () {\n        return _this.tagInput.focus();\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"handleClose\", function (removedTag) {\n      _this.setState(function (prevState) {\n        return {\n          tags: prevState.tags.filter(function (tag) {\n            return tag !== removedTag;\n          })\n        };\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"handleInputChange\", function (e) {\n      _this.setState({\n        inputValue: e.target.value\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"handleInputConfirm\", function () {\n      var tags = _this.state.tags;\n      var inputValue = _this.state.inputValue;\n\n      if (inputValue && tags.indexOf(inputValue) === -1) {\n        tags = [].concat(_toConsumableArray(tags), [inputValue]);\n      }\n\n      _this.setState({\n        tags: tags,\n        inputVisible: false,\n        inputValue: ''\n      });\n    });\n\n    _this.state = {\n      loading: false,\n      startAtValue: null,\n      endAtValue: null,\n      // 文件上传\n      contentFile: undefined,\n      introFile: undefined,\n      videoFile: [],\n      // 富文本\n      description: undefined,\n      suitableCrowd: undefined,\n      tutorIntroduction: undefined,\n      // 标签\n      tags: [],\n      inputVisible: false,\n      inputValue: ''\n    };\n    return _this;\n  }\n\n  _createClass(CreateOrEditContainer, [{\n    key: \"componentWillUnmount\",\n    value: function componentWillUnmount() {\n      this.setState({\n        loading: false\n      });\n    }\n  }, {\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      var _this2 = this;\n\n      var _Router$query = Router.query,\n          type = _Router$query.type,\n          itemId = _Router$query.itemId;\n      this.isEdit = type === 'edit';\n      this.isClone = type === 'clone'; // 如果是 clone 和 edit 状态 回填数据\n\n      if (type !== 'create') {\n        this.client.query({\n          query: QueryGetSeriesById,\n          variables: {\n            input: {\n              id: itemId\n            }\n          }\n        }).then(function (res) {\n          if (res.data.getSkillCourseSeriesById) {\n            var _res$data$getSkillCou = res.data.getSkillCourseSeriesById,\n                name = _res$data$getSkillCou.name,\n                startAt = _res$data$getSkillCou.startAt,\n                endAt = _res$data$getSkillCou.endAt,\n                courseHighlights = _res$data$getSkillCou.courseHighlights,\n                description = _res$data$getSkillCou.description,\n                suitableCrowd = _res$data$getSkillCou.suitableCrowd,\n                tutorIntroduction = _res$data$getSkillCou.tutorIntroduction,\n                pictureUrl = _res$data$getSkillCou.pictureUrl,\n                courseContentPicUrl = _res$data$getSkillCou.courseContentPicUrl,\n                videoUrl = _res$data$getSkillCou.videoUrl,\n                tags = _res$data$getSkillCou.tags;\n\n            _this2.setState({\n              description: description,\n              suitableCrowd: suitableCrowd,\n              tutorIntroduction: tutorIntroduction,\n              tags: tags.map(function (v) {\n                return v.name;\n              }),\n              introFile: pictureUrl,\n              contentFile: courseContentPicUrl,\n              videoFile: videoUrl\n            });\n\n            _this2.props.form.setFieldsValue({\n              name: name,\n              pictureUrl: pictureUrl,\n              courseContentPicUrl: courseContentPicUrl,\n              videoUrl: videoUrl,\n              startAt: _this2.isClone ? undefined : moment(startAt),\n              endAt: _this2.isClone ? undefined : moment(endAt),\n              courseHighlights: courseHighlights\n            });\n          }\n        });\n      }\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _this3 = this;\n\n      var getFieldDecorator = this.props.form.getFieldDecorator;\n      var _this$state2 = this.state,\n          loading = _this$state2.loading,\n          videoFile = _this$state2.videoFile,\n          introFile = _this$state2.introFile,\n          contentFile = _this$state2.contentFile,\n          tags = _this$state2.tags,\n          description = _this$state2.description,\n          suitableCrowd = _this$state2.suitableCrowd,\n          tutorIntroduction = _this$state2.tutorIntroduction,\n          inputVisible = _this$state2.inputVisible,\n          inputValue = _this$state2.inputValue;\n      return React.createElement(ApolloConsumer, null, function (client) {\n        _this3.client = client;\n        return React.createElement(_Form, {\n          colon: false\n        }, React.createElement(\"div\", {\n          style: {\n            width: '478px'\n          }\n        }, React.createElement(_Form.Item, {\n          label: \"\\u8BFE\\u7A0B\\u540D\\u79F0\"\n        }, getFieldDecorator('name', {\n          rules: [{\n            required: true,\n            message: '当前字段不可为空'\n          }]\n        })(React.createElement(LimitedInput, {\n          placeholder: \"\\u5BF9\\u5916\\u53EF\\u89C1\",\n          limit: 64\n        }))), React.createElement(DateWrapper, null, React.createElement(_Form.Item, {\n          label: \"\\u5F00\\u59CB\\u65F6\\u95F4\",\n          style: {\n            width: 224\n          }\n        }, getFieldDecorator('startAt', {\n          rules: [{\n            required: true,\n            message: '当前字段不可为空'\n          }]\n        })(React.createElement(_DatePicker, {\n          format: \"YYYY/MM/DD\",\n          placeholder: \"\\u5F00\\u59CB\\u65E5\\u671F\",\n          showToday: true,\n          disabledDate: _this3.disabledStartDate,\n          onChange: _this3.onStartChange\n        }))), React.createElement(_Form.Item, {\n          label: \"\\u7ED3\\u675F\\u65F6\\u95F4\",\n          style: {\n            width: 224\n          }\n        }, getFieldDecorator('endAt', {\n          rules: [{\n            required: true,\n            message: '当前字段不可为空'\n          }]\n        })(React.createElement(_DatePicker, {\n          disabledDate: _this3.disabledEndDate,\n          showToday: true,\n          format: \"YYYY/MM/DD\",\n          placeholder: \"\\u7ED3\\u675F\\u65E5\\u671F\",\n          onChange: _this3.onEndChange\n        })))), React.createElement(_Form.Item, {\n          label: React.createElement(LabelWrapper, null, \"\\u8BFE\\u7A0B\\u5C01\\u9762\\u56FE\", React.createElement(LabelDescription, null, \"\\u5EFA\\u8BAE\\u5C3A\\u5BF8\\uFF1A654*340px\"))\n        }, React.createElement(PicWrapper, {\n          hidden: !introFile,\n          style: {\n            backgroundImage: \"url(\".concat(introFile, \")\")\n          }\n        }), React.createElement(FilePicker, {\n          onRef: _this3.onRef.bind(_this3, 'introFile'),\n          fileType: \"image-only\",\n          selectType: \"single\",\n          getSelected: _this3.getFile.bind(_this3, 'introFile')\n        }), getFieldDecorator('pictureUrl', {\n          rules: [{\n            required: true,\n            message: '当前字段不可为空'\n          }]\n        })(React.createElement(ButtonWrapper, {\n          onClick: _this3.onClickBtn.bind(_this3, 'introFile')\n        }, \"\\u9009\\u62E9\\u56FE\\u7247\"))), React.createElement(_Form.Item, {\n          label: React.createElement(LabelWrapper, null, \"\\u8BFE\\u7A0B\\u5185\\u5BB9\\u56FE\", React.createElement(LabelDescription, null, \"\\u5EFA\\u8BAE\\u5C3A\\u5BF8\\uFF1A180*240px\"))\n        }, React.createElement(PicWrapper, {\n          hidden: !contentFile,\n          style: {\n            backgroundImage: \"url(\".concat(contentFile, \")\")\n          }\n        }), React.createElement(FilePicker, {\n          onRef: _this3.onRef.bind(_this3, 'contentFile'),\n          fileType: \"image-only\",\n          selectType: \"single\",\n          getSelected: _this3.getFile.bind(_this3, 'contentFile')\n        }), getFieldDecorator('courseContentPicUrl', {\n          rules: [{\n            message: '此字段无法为空',\n            required: true\n          }]\n        })(React.createElement(ButtonWrapper, {\n          onClick: _this3.onClickBtn.bind(_this3, 'contentFile')\n        }, \"\\u9009\\u62E9\\u56FE\\u7247\"))), React.createElement(_Form.Item, {\n          label: React.createElement(LabelWrapper, null, \"\\u8BFE\\u7A0B\\u4ECB\\u7ECD\\u89C6\\u9891\", React.createElement(LabelDescription, null, \"\\u53EF\\u6DFB\\u52A0\\u591A\\u4E2A\"))\n        }, videoFile.map(function (v) {\n          return React.createElement(\"p\", {\n            key: v.id\n          }, v.filename, React.createElement(\"a\", {\n            onClick: _this3.deselect.bind(_this3, v.id)\n          }, React.createElement(_Icon, {\n            type: \"close\"\n          })));\n        }), React.createElement(FilePicker, {\n          onRef: _this3.onRef.bind(_this3, 'videoFile'),\n          fileType: \"video-only\",\n          selectType: \"multiple\",\n          getSelected: _this3.getFile.bind(_this3, 'videoFile')\n        }), getFieldDecorator('videoUrl')(React.createElement(ButtonWrapper, {\n          onClick: _this3.onClickBtn.bind(_this3, 'videoFile')\n        }, \"\\u9009\\u62E9\\u89C6\\u9891\"))), React.createElement(_Form.Item, {\n          label: \"\\u8BFE\\u7A0B\\u4EAE\\u70B9\"\n        }, getFieldDecorator('courseHighlights')(React.createElement(TextArea, {\n          rows: 3,\n          placeholder: \"\\u8BF7\\u8F93\\u5165\"\n        })))), React.createElement(_Form.Item, {\n          label: \"\\u8BE6\\u7EC6\\u4ECB\\u7ECD\",\n          style: {\n            width: 1017\n          }\n        }, React.createElement(RichTextEditor, {\n          key: description,\n          apikey: 'ADQyLt4yBR7GH9oPjPODCz',\n          setValue: description,\n          getValue: _this3.handleFieldChange.bind(_this3, 'description')\n        })), React.createElement(_Form.Item, {\n          label: \"\\u9002\\u5408\\u4EBA\\u7FA4\",\n          style: {\n            width: 1017\n          }\n        }, React.createElement(RichTextEditor, {\n          key: suitableCrowd,\n          apikey: 'ADQyLt4yBR7GH9oPjPODCz',\n          setValue: suitableCrowd,\n          getValue: _this3.handleFieldChange.bind(_this3, 'suitableCrowd')\n        })), React.createElement(_Form.Item, {\n          label: \"\\u5BFC\\u5E08\\u56E2\\u961F\\u4ECB\\u7ECD\",\n          style: {\n            width: 1017\n          }\n        }, React.createElement(RichTextEditor, {\n          key: tutorIntroduction,\n          apikey: 'ADQyLt4yBR7GH9oPjPODCz',\n          setValue: tutorIntroduction,\n          getValue: _this3.handleFieldChange.bind(_this3, 'tutorIntroduction')\n        })), React.createElement(_Form.Item, {\n          label: \"\\u8BFE\\u7A0B\\u6807\\u7B7E\"\n        }, tags.map(function (v) {\n          return React.createElement(_Tag, {\n            key: v,\n            closable: true,\n            onClose: _this3.handleClose.bind(_this3, v)\n          }, v);\n        }), inputVisible && React.createElement(_Input, {\n          ref: _this3.saveInputRef,\n          type: \"text\",\n          size: \"small\",\n          style: {\n            width: 78\n          },\n          value: inputValue,\n          onChange: _this3.handleInputChange,\n          onBlur: _this3.handleInputConfirm,\n          onPressEnter: _this3.handleInputConfirm\n        }), !inputVisible && React.createElement(_Tag, {\n          onClick: _this3.showInput,\n          style: {\n            background: '#fff',\n            borderStyle: 'dashed'\n          }\n        }, React.createElement(_Icon, {\n          type: \"plus\"\n        }), \" \\u6807\\u7B7E\")), React.createElement(FooterWrapper, null, React.createElement(_Button, {\n          style: {\n            marginRight: 12\n          },\n          onClick: _this3.goBack\n        }, \"\\u53D6\\u6D88\"), React.createElement(_Button, {\n          type: \"primary\",\n          onClick: _this3.onClickCreateBtn,\n          loading: loading\n        }, _this3.isEdit ? '保存' : '创建周期')));\n      });\n    }\n  }]);\n\n  return CreateOrEditContainer;\n}(Component);\n\nvar CreateOrEditSeries = _Form.create()(CreateOrEditContainer);\n\nexport default CreateOrEditSeries;\nvar FooterWrapper = styled.div.withConfig({\n  displayName: \"CreateOrEditContainer__FooterWrapper\",\n  componentId: \"sc-16vkidv-0\"\n})([\"margin:77px 0 59px;\"]);\nvar PicWrapper = styled.div.withConfig({\n  displayName: \"CreateOrEditContainer__PicWrapper\",\n  componentId: \"sc-16vkidv-1\"\n})([\"position:relative;width:200px;height:104px;background-position:center;background-repeat:no-repeat;background-size:cover;\"]);\nvar DateWrapper = styled.div.withConfig({\n  displayName: \"CreateOrEditContainer__DateWrapper\",\n  componentId: \"sc-16vkidv-2\"\n})([\"display:flex;justify-content:space-around;\"]);\nvar ButtonWrapper = styled(_Button).withConfig({\n  displayName: \"CreateOrEditContainer__ButtonWrapper\",\n  componentId: \"sc-16vkidv-3\"\n})([\"width:224px;\"]);","map":null,"metadata":{},"sourceType":"module"}