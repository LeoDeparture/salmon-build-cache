{"ast":null,"code":"import \"antd/lib/modal/style\";\nimport _Modal from \"antd/lib/modal\";\nimport \"antd/lib/date-picker/style\";\nimport _DatePicker from \"antd/lib/date-picker\";\nimport \"antd/lib/form/style\";\nimport _Form from \"antd/lib/form\";\nimport \"antd/lib/input-number/style\";\nimport _InputNumber from \"antd/lib/input-number\";\nimport _toConsumableArray from \"@babel/runtime-corejs2/helpers/esm/toConsumableArray\";\nimport _regeneratorRuntime from \"@babel/runtime-corejs2/regenerator\";\nimport \"antd/lib/message/style\";\nimport _message from \"antd/lib/message\";\nimport _asyncToGenerator from \"@babel/runtime-corejs2/helpers/esm/asyncToGenerator\";\nimport _classCallCheck from \"@babel/runtime-corejs2/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime-corejs2/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"@babel/runtime-corejs2/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"@babel/runtime-corejs2/helpers/esm/getPrototypeOf\";\nimport _assertThisInitialized from \"@babel/runtime-corejs2/helpers/esm/assertThisInitialized\";\nimport _inherits from \"@babel/runtime-corejs2/helpers/esm/inherits\";\nimport _defineProperty from \"@babel/runtime-corejs2/helpers/esm/defineProperty\";\nimport \"antd/lib/input/style\";\nimport _Input from \"antd/lib/input\";\nimport moment from 'moment';\nimport React, { Component } from 'react';\nimport { ApolloConsumer } from 'react-apollo';\nimport styled from 'styled-components';\nimport FileUpload from '../../../../../components/FileUpload';\nimport { priceText } from '../../../../../lib/commonJs';\nimport { NoEmptyInputRule, NoEmptyOtherRule } from '../../../../../lib/commonRule';\nimport { MutationRefund } from '../../containers/MutationRefund';\nimport { disabledRefundDate } from '../../functions';\nimport File from '../File';\nimport { dateFormat, ModalContent, SubtitleText, TitleText } from './ApproveModal';\nvar TextArea = _Input.TextArea;\n\nvar RefundModal =\n/*#__PURE__*/\nfunction (_Component) {\n  _inherits(RefundModal, _Component);\n\n  function RefundModal(props) {\n    var _this;\n\n    _classCallCheck(this, RefundModal);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(RefundModal).call(this, props));\n\n    _defineProperty(_assertThisInitialized(_this), \"switchPop\", function () {\n      // 关闭时清空上传的文件\n      if (_this.state.visible) {\n        _this.setState({\n          file: undefined\n        });\n      }\n\n      _this.setState(function (state) {\n        return {\n          visible: !state.visible\n        };\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"handleOk\", function (e) {\n      e.preventDefault(); // 第一次点击时, 开启退款凭证校验\n\n      var file = _this.state.file;\n\n      _this.setState({\n        file: file ? file : null\n      });\n\n      _this.props.form.validateFieldsAndScroll(\n      /*#__PURE__*/\n      function () {\n        var _ref = _asyncToGenerator(\n        /*#__PURE__*/\n        _regeneratorRuntime.mark(function _callee(err, fieldsValue) {\n          var serviceTicketId, amount, reason, refundDate, response, size, name;\n          return _regeneratorRuntime.wrap(function _callee$(_context) {\n            while (1) {\n              switch (_context.prev = _context.next) {\n                case 0:\n                  if (!err && file) {\n                    // 执行接口\n                    serviceTicketId = _this.props.serviceTicketId;\n                    amount = fieldsValue.amount, reason = fieldsValue.reason, refundDate = fieldsValue.refundDate;\n                    response = file.response, size = file.size, name = file.name;\n\n                    _this.setState({\n                      loading: true\n                    });\n\n                    _this.client.mutate({\n                      mutation: MutationRefund,\n                      variables: {\n                        input: {\n                          id: serviceTicketId,\n                          amount: Math.round(amount * 100),\n                          reason: reason,\n                          refundDate: refundDate.toISOString(),\n                          credential: {\n                            url: response,\n                            filename: name,\n                            size: size\n                          }\n                        }\n                      }\n                    }).then(function (result) {\n                      if (result) {\n                        _message.success('已通过退款');\n\n                        _this.switchPop();\n                      }\n                    }).finally(function () {\n                      _this.setState({\n                        loading: false\n                      });\n                    });\n                  }\n\n                case 1:\n                case \"end\":\n                  return _context.stop();\n              }\n            }\n          }, _callee);\n        }));\n\n        return function (_x, _x2) {\n          return _ref.apply(this, arguments);\n        };\n      }());\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"onUpload\", function (data) {\n      if (data && data[0]) {\n        _this.setState({\n          file: data[0]\n        });\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"onDeleteFile\", function () {\n      _this.setState({\n        file: null\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"checkAmount\", function (_, value, callback) {\n      var actualPrice = _this.props.actualPrice;\n\n      if (typeof value !== 'number') {\n        callback('请输入正确的数字');\n      }\n\n      if (value < 1) {\n        callback('退款金额不能小于1');\n      }\n\n      if (value > actualPrice / 100) {\n        callback('退款金额不能大于服务单总价');\n      }\n\n      callback();\n    });\n\n    _this.state = {\n      visible: false,\n      loading: false,\n      file: undefined\n    };\n    return _this;\n  }\n\n  _createClass(RefundModal, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      this.props.onRef(this);\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _this2 = this;\n\n      var _this$props = this.props,\n          actualPrice = _this$props.actualPrice,\n          serviceTicketLink = _this$props.serviceTicketLink;\n      var _this$state = this.state,\n          visible = _this$state.visible,\n          loading = _this$state.loading,\n          file = _this$state.file;\n      var getFieldDecorator = this.props.form.getFieldDecorator;\n      var title = React.createElement(React.Fragment, null, React.createElement(TitleText, null, \"\\u9000\\u6B3E\"), React.createElement(SubtitleText, null, \"\\u57FA\\u4E8E\\u670D\\u52A1\\u5355\", React.createElement(\"span\", null, \" \", serviceTicketLink, \" \"), \"\\u8FDB\\u884C\\u9000\\u6B3E\\u3002\", React.createElement(\"span\", {\n        style: {\n          float: 'right'\n        }\n      }, \"\\u670D\\u52A1\\u5355\\u603B\\u4EF7\\uFF08CNY\\uFF09\\uFF1A\", React.createElement(\"span\", {\n        style: {\n          color: '#172B4D'\n        }\n      }, priceText(actualPrice)))));\n      var fileComponent = React.createElement(ApolloConsumer, null, function (client) {\n        _this2.client = client;\n\n        if (file) {\n          return React.createElement(File, {\n            name: file.name,\n            url: file.response,\n            showDelete: true,\n            onClickDelete: _this2.onDeleteFile\n          });\n        }\n\n        return React.createElement(FileUploadWrapper, null, React.createElement(FileUpload, {\n          onChangeValue: _this2.onUpload,\n          multipleUpload: false,\n          desText: \"\\u53EA\\u80FD\\u4E0A\\u4F20\\u4E00\\u4E2A\\u534F\\u8BAE\\u9644\\u4EF6\"\n        }));\n      });\n      return React.createElement(React.Fragment, null, React.createElement(_Modal, {\n        title: title,\n        visible: visible,\n        closable: false,\n        maskClosable: false,\n        destroyOnClose: true,\n        okButtonProps: {\n          loading: loading,\n          type: 'ghost',\n          style: {\n            color: '#FF5230'\n          }\n        },\n        width: 720,\n        onOk: this.handleOk,\n        onCancel: this.switchPop,\n        okText: \"\\u786E\\u8BA4\\u9000\\u6B3E\",\n        cancelText: \"\\u53D6\\u6D88\"\n      }, React.createElement(ModalContent, {\n        style: {\n          maxHeight: '440px'\n        }\n      }, React.createElement(_Form.Item, {\n        style: formItemStyle,\n        label: \"\\u9000\\u6B3E\\u91D1\\u989D\\uFF08CNY\\uFF09\",\n        colon: false\n      }, getFieldDecorator('amount', {\n        rules: [].concat(_toConsumableArray(NoEmptyOtherRule), [{\n          validator: this.checkAmount\n        }]),\n        validateFirst: true\n      })(React.createElement(_InputNumber, {\n        style: inputStyle,\n        placeholder: \"\\u8BF7\\u8F93\\u5165\",\n        step: 1,\n        max: actualPrice / 100,\n        precision: 0,\n        min: 1\n      }))), React.createElement(_Form.Item, {\n        style: formItemStyle,\n        label: \"\\u9000\\u6B3E\\u539F\\u56E0\",\n        colon: false\n      }, getFieldDecorator('reason', {\n        rules: NoEmptyInputRule\n      })(React.createElement(TextArea, {\n        style: inputStyle,\n        placeholder: \"\\u8BF7\\u8F93\\u5165\"\n      }))), React.createElement(_Form.Item, {\n        style: formItemStyle,\n        label: \"\\u9000\\u6B3E\\u51ED\\u8BC1\",\n        colon: false,\n        required: true,\n        validateStatus: \"error\",\n        help: !file && typeof file === 'object' ? '请上传退款凭证' : ''\n      }, fileComponent), React.createElement(_Form.Item, {\n        style: formItemStyle,\n        label: \"\\u9000\\u6B3E\\u65E5\\u671F\",\n        colon: false\n      }, getFieldDecorator('refundDate', {\n        rules: NoEmptyOtherRule,\n        initialValue: moment(new Date(), dateFormat)\n      })(React.createElement(_DatePicker, {\n        disabledDate: disabledRefundDate,\n        format: dateFormat,\n        style: inputStyle,\n        placeholder: \"\\u8BF7\\u9009\\u62E9\"\n      }))))));\n    }\n  }]);\n\n  return RefundModal;\n}(Component);\n\nexport default _Form.create()(RefundModal);\nvar formItemStyle = {\n  fontSize: '14px',\n  color: '#172b4d'\n};\nvar inputStyle = {\n  width: '400px'\n};\nvar FileUploadWrapper = styled.div.withConfig({\n  displayName: \"RefundModal__FileUploadWrapper\",\n  componentId: \"yqdpsu-0\"\n})([\"width:200px;\"]);","map":null,"metadata":{},"sourceType":"module"}